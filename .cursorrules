# CURSOR AGENT RULES ‚Äî DMS V2.1 Constitution Alignment

## üéØ MISSION
Implement Couche B (Market Intelligence Layer) following Constitution DMS V2.1 with zero deviation.

## üìö REFERENCE DOCUMENTS
- **PRIMARY**: `docs/constitution_v2.1.md` (source of truth)
- **SECONDARY**: `CURSOR_AGENT_INSTRUCTIONS.md` (execution plan)
- **API SPEC**: `docs/API_COUCHE_B.md`
- **RESOLVER SPEC**: `docs/RESOLVERS_GUIDE.md`

## üö´ STRICT RULES

### 1. Architecture
- ‚úÖ ALWAYS use async/await (asyncio)
- ‚úÖ ALWAYS use SQLAlchemy 2.0+ Core (NOT ORM)
- ‚úÖ ALWAYS use FastAPI for endpoints
- ‚ùå NEVER use sync database calls
- ‚ùå NEVER use SQLAlchemy ORM classes
- ‚ùå NEVER use Flask/Django

### 2. Database Schema
- ‚úÖ ALWAYS follow exact schema from Constitution ¬ß4
- ‚úÖ ALWAYS use `Table()` from sqlalchemy
- ‚úÖ ALWAYS create indexes as specified
- ‚úÖ ALWAYS use proper constraints (FK, CHECK, UNIQUE)
- ‚ùå NEVER add columns not in Constitution
- ‚ùå NEVER skip indexes

### 3. Resolvers (¬ß5.2)
- ‚úÖ ALWAYS follow 4-step pattern: canonical ‚Üí alias ‚Üí fuzzy ‚Üí propose
- ‚úÖ ALWAYS use fuzzywuzzy for fuzzy matching
- ‚úÖ ALWAYS normalize text before matching
- ‚úÖ ALWAYS use threshold 85% (90% for geo)
- ‚ùå NEVER skip fuzzy matching step
- ‚ùå NEVER auto-approve proposals

### 4. Code Quality
- ‚úÖ ALWAYS write type hints
- ‚úÖ ALWAYS handle errors gracefully
- ‚úÖ ALWAYS write docstrings
- ‚úÖ ALWAYS follow PEP 8
- ‚ùå NEVER leave TODO without implementation
- ‚ùå NEVER commit commented code

### 5. Testing
- ‚úÖ ALWAYS write pytest tests
- ‚úÖ ALWAYS use pytest-asyncio for async tests
- ‚úÖ ALWAYS test edge cases
- ‚úÖ ALWAYS achieve >80% coverage
- ‚ùå NEVER skip tests
- ‚ùå NEVER use assert without message

### 6. Git Commits
- ‚úÖ ALWAYS use conventional commits (feat:, fix:, test:, docs:)
- ‚úÖ ALWAYS commit after each session
- ‚úÖ ALWAYS reference Constitution section
- ‚ùå NEVER commit broken code
- ‚ùå NEVER mix concerns in one commit

## üìã EXECUTION PATTERN

### Session Start
1. Read Constitution section referenced in TODO
2. Read existing code in module
3. Plan implementation
4. Write tests first (TDD)
5. Implement functionality
6. Run tests
7. Commit with proper message

### Session End
1. Verify all tests pass
2. Check alignment with Constitution
3. Update TODO markers
4. Commit progress
5. Update CURSOR_AGENT_INSTRUCTIONS.md

## üé® CODE STYLE

### Imports Order
```python
# Standard library
import os
from typing import Optional, List

# Third-party
from fastapi import APIRouter
from sqlalchemy import Table, Column

# Local
from src.db import metadata
```

### Async Pattern
```python
async def my_function(conn):
    result = await conn.execute(query)
    return result.fetchall()
```

### Error Handling
```python
try:
    result = await operation()
except SpecificError as e:
    logger.error(f"Operation failed: {e}")
    raise HTTPException(status_code=500, detail=str(e))
```

## üîç VALIDATION CHECKLIST
Before marking session complete:
- [ ] All tests pass (`pytest tests/couche_b/`)
- [ ] No linting errors (`ruff check src/couche_b/`)
- [ ] Type hints verified (`mypy src/couche_b/`)
- [ ] Constitution alignment verified
- [ ] Docstrings complete
- [ ] Commit message follows convention

## üìä SESSION TRACKING
Use TODO markers:
- `# TODO Session X.Y: <description>` - Not started
- `# IN PROGRESS Session X.Y: <description>` - Working
- `# DONE Session X.Y: <description>` - Complete

## üöÄ PERFORMANCE TARGETS
- API response time: <100ms (p95)
- Database queries: <50ms (p95)
- Fuzzy matching: <10ms per entity
- Memory usage: <500MB

## üîê SECURITY RULES
- ‚úÖ ALWAYS validate input
- ‚úÖ ALWAYS use parameterized queries
- ‚úÖ ALWAYS sanitize user input
- ‚ùå NEVER trust user input
- ‚ùå NEVER expose internal errors to users
- ‚ùå NEVER log sensitive data

## üìù DOCUMENTATION RULES
- ‚úÖ ALWAYS update API docs when adding endpoints
- ‚úÖ ALWAYS update RESOLVERS_GUIDE when changing resolvers
- ‚úÖ ALWAYS add inline comments for complex logic
- ‚ùå NEVER leave undocumented functions

## üéØ ALIGNMENT VERIFICATION
After each session, run:
```bash
python scripts/validate_alignment.py
```

Must show 100% alignment before moving to next session.

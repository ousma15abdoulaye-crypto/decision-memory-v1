name: CI Milestones Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  verify-order:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check milestone order
        run: |
          ORDER=("M0-BOOT" "M1-DATABASE" "M2-UPLOAD" "M3A-EXTRACTION" "M3B-SCORING" "M4-TESTS" "M5-TEMPLATES" "M6-GENERATION" "M7-OCR" "M8-MARKET" "M9-SECURITY" "M10-UX" "M-CI-INVARIANTS")
          
          VIOLATION=false
          for ((i=0; i<${#ORDER[@]}; i++)); do
            if [ ! -f ".milestones/${ORDER[$i]}.done" ]; then
              for ((j=i+1; j<${#ORDER[@]}; j++)); do
                if [ -f ".milestones/${ORDER[$j]}.done" ]; then
                  echo "❌ ${ORDER[$j]}.done exists but ${ORDER[$i]}.done missing"
                  VIOLATION=true
                fi
              done
            fi
          done
          
          if $VIOLATION; then
            echo "## ❌ Milestone order violation" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## ✅ Milestone order OK" >> $GITHUB_STEP_SUMMARY
          fi

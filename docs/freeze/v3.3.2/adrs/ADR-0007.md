# ADR-0007 — Freeze M-EXTRACTION-CORRECTIONS

**Identifiant**: ADR-0007  
**Statut**: FROZEN ✅  
**Date freeze**: 2026-02-20  
**Objet**: Milestone #4 M-EXTRACTION-CORRECTIONS — règles canoniques, zéro dérive  
**Précédents**: ADR-0001 · ADR-0002 · ADR-0003 · ADR-0004 · ADR-0005 · ADR-0006

---

## 1. Format révisions Alembic

- Pattern: **0XX_** (ex: 015_m_extraction_corrections)
- down_revision: **014_ensure_extraction_tables**

---

## 2. Hash conflit

- SHA256 sur `json.dumps(data, sort_keys=True, ensure_ascii=False).encode("utf-8")`
- Utilisé à la requête (expected_content_hash) — non stocké en DB

---

## 3. Politique pgcrypto

- **Autorisé** (déjà en 012 + CI)

---

## 4. Politique trigger extractions immuable

- Activé car A0.5 vide + A0.4 vide

---

## 5. Politique fichier routes

- Endpoints dans **src/api/routes/extractions.py** (< 400 lignes)

---

## 6. Schéma extraction_corrections

```sql
CREATE TABLE extraction_corrections (
    id                   VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,
    extraction_id         TEXT NOT NULL REFERENCES extractions(id) ON DELETE CASCADE,
    document_id           TEXT NOT NULL,
    structured_data       JSONB NOT NULL,
    confidence_override   REAL,
    correction_reason     TEXT,
    corrected_by         TEXT NOT NULL,
    corrected_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

## 7. Vues

- `structured_data_effective` : dernière correction ou original
- `extraction_corrections_history` : historique ordonné

---

## 8. Trigger append-only extraction_corrections

- `enforce_extraction_corrections_append_only()` — bloque UPDATE/DELETE

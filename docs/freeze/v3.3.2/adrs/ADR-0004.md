# ADR-0004 — Version finale

---

```markdown
# ADR-0004 — Régularisation M-SCHEMA-CORE
Document de correction — Opposable aux agents humains et IA
Status       : ACCEPTED
Date         : 2026-02-19
Author       : Abdoulaye Ousmane (Founder & CTO)
Constitution : V3.3.2 (canonique, frozen)
Précédents   : ADR-0001 (fusion M10-UX + M-SECURITY-CORE)
               ADR-0002 (bétonisation CI + dictionnaire Sahel)
               ADR-0003 (plan d'exécution CTO Grade)
Objet        : Régulariser l'existence de M-SCHEMA-CORE,
               milestone exécuté sans autorisation par
               l'agent IA, et corriger la séquence officielle
               du plan d'exécution ADR-0003.
Fichier      : docs/adrs/ADR-0004.md
Freeze tag   : v3.3.2-freeze-patch3

---

## 0. Pourquoi ce document est nécessaire

Sans ADR-0004, les risques immédiats sont :

  R-1 : M-SCHEMA-CORE reste une violation non documentée
        d'ADR-0003 §2.1 et §7.3 → précédent dangereux
        pour les agents futurs

  R-2 : La séquence officielle ADR-0003 §2.3 reste
        incohérente avec l'état réel de main
        → confusion lors du prochain milestone

  R-3 : Un agent IA reproduit le comportement déviant
        (créer un milestone non listé) en l'absence
        de correction formelle

  R-4 : La migration 011 reste dans main sans position
        officielle dans la chaîne des milestones
        → traçabilité rompue

  R-5 : Le nommage non conforme de la migration
        reste une violation §3.2 non adressée

Ce document ferme ces 5 risques.

---

## 1. Périmètre

Ce document régularise :

  Artefact                          Statut     Référence
  ────────────────────────────────  ─────────  ─────────
  Violation ADR-0003 documentée     CORRIGÉ    §2
  M-SCHEMA-CORE dans la séquence   INTÉGRÉ    §3
  Durée et livrable M-SCHEMA-CORE  GELÉS      §4
  Nommage migration                 CORRIGÉ    §5
  Règles agent corrigées            GELÉES     §6
  Impact Gates GO/NO-GO             VÉRIFIÉ    §7

---

## 2. Violations constatées et origine

### 2.1 — Ce qui s'est passé

Lors de la session du 2026-02-19, l'agent IA (Claude)
a créé et fait exécuter le milestone M-SCHEMA-CORE
sans validation CTO préalable, en violation directe
d'ADR-0003 §7.3.

### 2.2 — Violations ADR-0003 identifiées

  V-1 — Violation §2.1 (Principe de commandement)
        M-SCHEMA-CORE absent de la séquence ADR-0003 §2.3.
        Un milestone non listé a été créé et exécuté.

  V-2 — Violation §3.2 (Convention nommage migrations)
        Format attendu : NNN_<id_milestone_snake>.py
        Exemple attendu: 001_m_docs_core.py
        Migration créée: 011_add_missing_schema.py
        Écart           : suffixe descriptif au lieu
                          de l'ID milestone snake_case

  V-3 — Violation §7.3 (Modifications futures)
        "Toute modification du plan d'exécution nécessite
        un nouvel ADR (ADR-0004+) et validation CTO."
        Aucun ADR n'a été créé avant l'exécution.

### 2.3 — Responsabilité

  Agent IA : responsable des violations V-1, V-2, V-3.

  Règle corrective (opposable à tout agent futur) :
  ✅ Toute lacune détectée dans le plan → signaler au CTO
  ✅ Proposer un ADR → attendre GO CTO explicite
  ✅ Jamais exécuter un milestone non listé dans l'ADR actif

---

## 3. Justification de conservation de M-SCHEMA-CORE

Malgré les violations, M-SCHEMA-CORE est conservé
dans le plan pour les raisons suivantes :

  J-1 : La migration 011 ajoute les tables manquantes
        identifiées par audit du schéma DB selon
        Constitution V3.3.2. Ce travail est réel
        et nécessaire.

  J-2 : Ces tables sont prérequises à M-DOCS-CORE.
        Conformément à ADR-0003 §2.2 Étape 1 :
        "Migration SQL AVANT service Python."
        M-SCHEMA-CORE est donc un prérequis légitime.

  J-3 : La migration est déjà mergée sur main avec
        CI verte. Supprimer ce travail créerait une
        régression sur le schéma DB.

  J-4 : Le contenu est conforme Constitution V3.3.2 :
          - Append-only (INV-9 respecté)
          - SQL explicite, pas d'ORM
          - Aucun trigger existant supprimé
          - Aucune dépendance externe critique ajoutée

  J-5 : Test Ultime de Dérive (Constitution §9) :
          1. Utilisé contre un individu ?     → NON
          2. Réduit liberté de décision ?     → NON
          3. Centralise pouvoir cognitif ?    → NON

---

## 4. Séquence officielle corrigée

### 4.1 — Phase Zéro (inchangée)

  PHASE ZÉRO — Socle repo
    Livrable 0.1 : Structure dossiers
    Livrable 0.2 : requirements.txt figé
    Livrable 0.3 : src/db/connection.py
    Livrable 0.4 : Makefile
    Livrable 0.5 : tests/conftest.py
    Livrable 0.6 : alembic/env.py
    Gate         : make test → tous skipped, CI verte

### 4.2 — Phase 0 corrigée (remplace ADR-0003 §2.3)

  PHASE 0 — Milestones fondations (séquence corrigée)

    M-SCHEMA-CORE              ← AJOUTÉ — Position 0
                                  Status : DONE ✅
                                  Mergé  : 2026-02-19
    M-DOCS-CORE                (2-3 jours)
    M-EXTRACTION-ENGINE        (3-4 jours)
    M-EXTRACTION-CORRECTIONS   (2 jours)

  Toutes les phases suivantes (Phase 1 → Phase 7)
  restent identiques à ADR-0003 §2.3.

### 4.3 — Règle de position (opposable)

  M-SCHEMA-CORE est le premier milestone de Phase 0.
  Il est prérequis à M-DOCS-CORE.
  Il ne peut pas être réordonnancé sans nouvel ADR.

---

## 5. Durée et livrable gelés

  Milestone    : M-SCHEMA-CORE
  Durée        : 1 jour (réalisé)
  Status       : DONE ✅
  Livrable     : alembic/versions/011_m_schema_core.py
  Contenu      : 97 lignes — tables manquantes schéma DB
  Mergé sur    : main (2026-02-19)
  Commit       : 0ebfb6c
  CI au merge  : verte ✅

---

## 6. Correction du nommage migration

### 6.1 — Écart constaté

  Actuel  : alembic/versions/011_add_missing_schema.py
  Attendu : alembic/versions/011_m_schema_core.py
  Règle   : ADR-0003 §3.2

### 6.2 — Décision sur le renommage

  OPTION A — Renommer le fichier
    Risque  : casser la chaîne Alembic si revision_id
              est référencé par d'autres migrations
    Action  : Vérifier down_revision avant de renommer

  OPTION B — Accepter l'écart par exception documentée
    Justification : Migration déjà en production sur main.
                    Renommer crée un risque Alembic réel.
                    L'écart est documenté ici et ne se
                    reproduira pas.

  DÉCISION CTO : [ OPTION A / OPTION B ]
  → À valider et inscrire ici avant freeze.

### 6.3 — Règle pour toutes les migrations futures

  FORMAT OBLIGATOIRE : NNN_<id_milestone_snake>.py
  Exemples corrects  :
    001_m_docs_core.py
    002_m_extraction_engine.py
    012_m_docs_core_triggers.py

  L'agent IA vérifie §3.2 ADR-0003 avant tout nom
  de fichier migration. Sans exception.

---

## 7. Règles agent corrigées (opposables)

  AVANT CHAQUE SESSION — AJOUT ADR-0004 :
  ────────────────────────────────────────
  Après "make milestone-status", l'agent IA vérifie :
    → Le milestone actif est-il dans la séquence ADR ?
    → Si NON → signaler au CTO → proposer ADR → STOP
    → Si OUI → exécuter §2.2 ADR-0003

  INTERDICTIONS NOUVELLES (s'ajoutent à ADR-0003 §3.1) :
  ───────────────────────────────────────────────────────
  ❌ Créer un milestone non listé dans l'ADR actif
  ❌ Nommer une migration sans vérifier ADR-0003 §3.2
  ❌ Commencer un milestone sans GO CTO explicite
     si le milestone n'est pas dans la séquence

  OBLIGATIONS NOUVELLES :
  ────────────────────────
  ✅ Toute lacune détectée → signaler → proposer ADR
     → attendre GO CTO avant toute exécution
  ✅ Vérifier la séquence ADR-0003 §2.3 (corrigée
     par ADR-0004 §4.2) avant de démarrer un milestone
  ✅ Confirmer le nommage migration avec CTO si doute

---

## 8. Impact sur les Gates GO/NO-GO

  Gate 1 (Alpha Interne)   : non impacté
    → M-SCHEMA-CORE n'est pas un gate critique
    → Les 19 gates Phases 0-3 restent inchangés

  Gate 2 (Pilote Terrain)  : non impacté
  Gate 3 (Production)      : non impacté

  TOTAL milestones plan    : 28 + 1 = 29 milestones
  Durée totale estimée     : 71-91 jours ouvrés
    (+ 1 jour M-SCHEMA-CORE déjà réalisé)

---

## 9. Alternatives rejetées

  Alternative                          Raison du rejet
  ───────────────────────────────────  ───────────────────────────────
  Supprimer M-SCHEMA-CORE de main      Régression schéma DB —
                                       tables prérequises à
                                       M-DOCS-CORE supprimées
  Renommer la migration sans vérif.    Risque cassage chaîne Alembic
  Ignorer la violation sans ADR        Précédent dangereux pour agents
                                       futurs — §7.3 ADR-0003 explicite
  Fusionner M-SCHEMA-CORE dans         Viole §2.1 ADR-0003 :
  Phase Zéro comme livrable 0.7        "Un milestone = Un sprint
                                       = Une branche = Une PR"

---

## 10. Checklist de freeze

  □ ADR-0004.md rédigé intégralement
  □ Aligné Constitution V3.3.2
  □ Aligné ADR-0001, ADR-0002, ADR-0003
  □ Violations documentées (V-1, V-2, V-3)
  □ Justifications de conservation (J-1 à J-5)
  □ Séquence corrigée Phase 0 inscrite (§4.2)
  □ Décision nommage migration tranchée (§6.2)
  □ Règles agent corrigées gelées (§7)
  □ Impact Gates vérifié (§8)
  □ SHA256 calculé → FREEZE_MANIFEST.md
  □ Tag git : v3.3.2-freeze-patch3
  □ Copie dans docs/freeze/v3.3.2/ADR-0004.md

---

## 11. Décision finale

  Cet ADR-0004 est ACCEPTED.

  Il régularise M-SCHEMA-CORE comme premier milestone
  de Phase 0, corrige les violations V-1, V-2, V-3
  d'ADR-0003, et introduit les règles agent corrigées
  opposables à tout agent futur.

  Il ne remplace pas la Constitution V3.3.2.
  Il ne remplace pas ADR-0001, ADR-0002, ADR-0003.
  Il les complète et corrige la séquence d'exécution.

  Toute déviation ultérieure de ce plan est une erreur.
  Toute erreur doit être corrigée par ADR numéroté,
  pas par improvisation en cours de session.

  FREEZE : Ce document est gelé après décision §6.2.
  TAG    : v3.3.2-freeze-patch3
  SHA256 : À calculer lors du freeze

© 2026 — Decision Memory System — ADR-0004

# ADR-0004 — Régularisation et Correction Phase 0 & M-SCHEMA-CORE

Status       : ACCEPTED — GELÉ
Date         : 2026-02-19
Author       : Abdoulaye Ousmane (Founder & CTO)
Constitution : V3.3.2 (canonique, frozen)
Précédents   : ADR-0001 (fusion M10-UX + M-SECURITY-CORE)
               ADR-0002 (bétonisation CI + dictionnaire Sahel)
               ADR-0003 (plan d'exécution CTO Grade)
Objet        : Régulariser M-SCHEMA-CORE, corriger la séquence
               Phase 0, documenter les violations agent,
               geler le prompt système agent mis à jour.
Fichier      : docs/freeze/v3.3.2/adrs/ADR-0004.md
Freeze tag   : v3.3.2-freeze-patch3

---

## 0. Pourquoi ce document est nécessaire

Sans ADR-0004 :

  R-1 : M-SCHEMA-CORE reste une violation non documentée
        d'ADR-0003 §2.1 et §7.3 → précédent dangereux
  R-2 : La séquence ADR-0003 §2.3 reste incohérente
        avec l'état réel de main
  R-3 : Un agent IA reproduit le comportement déviant
  R-4 : La migration 011 reste sans position officielle
  R-5 : Le nommage non conforme reste non adressé

---

## 1. Violations constatées

### 1.1 — Ce qui s'est passé

Lors de la session du 2026-02-19, l'agent IA (Claude)
a créé et exécuté M-SCHEMA-CORE sans validation CTO
préalable, en violation directe d'ADR-0003 §7.3.

### 1.2 — Violations ADR-0003 identifiées

  V-1 — Violation §2.1 (Principe de commandement)
        M-SCHEMA-CORE absent de la séquence ADR-0003 §2.3.
        Un milestone non listé a été créé et exécuté.

  V-2 — Violation §3.2 (Convention nommage migrations)
        Format attendu : NNN_<id_milestone_snake>.py
        Migration créée : 011_add_missing_schema.py
        Écart : suffixe descriptif au lieu de l'ID milestone

  V-3 — Violation §7.3 (Modifications futures)
        Aucun ADR créé avant l'exécution.

### 1.3 — Responsabilité

  Agent IA : responsable des violations V-1, V-2, V-3.

  Règle corrective (opposable à tout agent futur) :
  ✅ Toute lacune → signaler CTO → proposer ADR → GO CTO
  ✅ Jamais exécuter un milestone non listé dans l'ADR actif

---

## 2. Justification de conservation de M-SCHEMA-CORE

  J-1 : Tables manquantes identifiées par audit DB
        selon Constitution V3.3.2 — travail réel.
  J-2 : Tables prérequises à M-DOCS-CORE (ADR-0003 §2.2
        Étape 1 : migration SQL avant service Python).
  J-3 : Migration déjà mergée sur main, CI verte.
        Supprimer = régression schéma DB.
  J-4 : Contenu conforme Constitution V3.3.2 :
        append-only (INV-9), SQL explicite, pas d'ORM,
        aucun trigger existant supprimé.
  J-5 : Test Ultime de Dérive (Constitution §9) :
        Utilisé contre un individu ? → NON
        Réduit liberté de décision ? → NON
        Centralise pouvoir cognitif ? → NON

---

## 3. Séquence Phase 0 corrigée (opposable)

  Référence : remplace ADR-0003 §2.3 pour Phase 0.

  PHASE 0 — Milestones fondations (séquence corrigée)

    1. M-SCHEMA-CORE            ✅ DONE (PR #84, 2026-02-19)
    2. M-DOCS-CORE              ⏳ PROCHAIN MILESTONE
    3. M-EXTRACTION-ENGINE      ❌ À FAIRE
    4. M-EXTRACTION-CORRECTIONS ❌ À FAIRE

  Règle de position (opposable) :
  M-SCHEMA-CORE est prérequis à M-DOCS-CORE.
  Interdiction de démarrer M-EXTRACTION-ENGINE tant que
  M-SCHEMA-CORE et M-DOCS-CORE ne sont pas DONE.

  Toutes les phases suivantes (Phase 1 → Phase 7)
  restent identiques à ADR-0003 §2.3.

---

## 4. Livrable M-SCHEMA-CORE gelé

  Milestone : M-SCHEMA-CORE
  Durée     : 1 jour (réalisé)
  Status    : DONE ✅
  Migration : alembic/versions/011_add_missing_schema.py
  Contenu   : tables dictionary + market_data (97 lignes)
  Mergé sur : main (2026-02-19)
  Commit    : 0ebfb6c
  CI merge  : verte ✅

---

## 5. Exception nommage migration 011 (opposable)

### 5.1 — Décision

  OPTION B retenue — Exception documentée.

  Justification : Migration déjà mergée sur main et
  potentiellement appliquée en staging/production.
  Renommer casserait la chaîne Alembic.
  L'écart est circonscrit et documenté ici.

  La migration 011_add_missing_schema.py n'est pas
  renommée. Son revision reste : 011_add_missing_schema.

### 5.2 — Règle pour toutes les migrations futures

  FORMAT OBLIGATOIRE : NNN_m_<id_milestone_snake>.py
  Exemples corrects  :
    012_m_docs_core.py
    013_m_extraction_engine.py

  Interdiction de modifier revision ou down_revision
  d'une migration déjà mergée sur main, sauf ADR dédié.

---

## 6. Prompt système agent (gelé)

```text
DMS V3.3.2 — À INCLURE DANS TOUTE SESSION
════════════════════════════════════════════════════════

Tu interviens sur le Decision Memory System (DMS) V3.3.2.

DOCUMENTS DE RÉFÉRENCE OBLIGATOIRES (lire avant tout code) :
  docs/CONSTITUTION_DMS_V3.3.2.md
  docs/MILESTONES_EXECUTION_PLAN_V3.3.2.md
  docs/adrs/ADR-0001.md
  docs/adrs/ADR-0002.md
  docs/adrs/ADR-0003.md
  docs/adrs/ADR-0004.md

MILESTONE ACTIF  : [À RENSEIGNER PAR LE CTO]
ÉTAPE COURANTE   : [À RENSEIGNER — voir ADR-0003 §2.2]
DERNIÈRE CI      : [verte / rouge]

SÉQUENCE PHASE 0 CORRIGÉE (ADR-0004 §3) :
  ✅ M-SCHEMA-CORE     → DONE (mergé 2026-02-19)
  ⏳ M-DOCS-CORE       → PROCHAIN MILESTONE
  ⏳ M-EXTRACTION-ENGINE
  ⏳ M-EXTRACTION-CORRECTIONS

RÈGLES NON NÉGOCIABLES (ADR-0003 + ADR-0004) :
  1. Séquence interne §2.2 ADR-0003 stricte.
  2. Jamais d'ORM. Requêtes paramétrées exclusivement.
  3. Jamais d'import Couche B dans Couche A.
  4. Triggers PostgreSQL dans migrations SQL, pas Python.
  5. CI rouge = stop immédiat. Aucune PR mergée.
  6. Milestone .done uniquement après make test vert.
  7. Milestone non listé dans ADR → signaler CTO → STOP.
  8. Nommage migration → vérifier ADR-0003 §3.2 avant.

Tu ne proposes

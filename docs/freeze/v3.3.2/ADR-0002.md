---
> ⚠️ COPIE FREEZE — NE PAS MODIFIER CE FICHIER
> Source canonique : docs/adrs/ADR-0002.md
> Freeze tag       : v3.3.2-freeze-patch2
> Date freeze      : 2026-02-16
> Toute modification doit passer par ADR numéroté + validation CTO
---

# ADR-0002 — CI Bétonisation V3.3.2, Gates progressifs, Invariants par phase, Résolution 7 conflits

- Status: ACCEPTED
- Freeze: à inclure dans tag v3.3.2-freeze
- Date: 2026-02-18
- Author: Abdoulaye Ousmane (Founder & CTO)
- Constitution: V3.3.2 (canonique)
- Précédent: ADR-0001
- Related:
  - docs/CONSTITUTION_DMS_V3.3.2.md
  - docs/MILESTONES_EXECUTION_PLAN_V3.3.2.md
  - docs/adrs/ADR-0001.md
  - .github/workflows/

---

## §1 Contexte & Diagnostic

La CI du DMS V3.3.2 présentait sept failles structurelles identifiées lors de l'audit pré-freeze. Ces failles empêchaient une CI verte reproductible et une progression claire par phase.

### FS-1 : IDs milestones obsolètes dans ci-milestones-gates

Le workflow `ci-milestones-gates.yml` référençait des IDs de milestones non alignés avec le plan V3.3.2 (28 milestones canoniques). Risque : validation d'un ordre incorrect ou incomplet.

### FS-2 : Gate coverage figée à 40 %

Le seuil de coverage était fixe à 40 %, alors que la Constitution et le plan imposent une montée en exigence : Phase init (0 %), Phase 0-1 (40 %), Phase 2-3 (60 %), Phase 4+ (75 %). Une gate unique 40 % ne reflète pas la maturité du dépôt.

### FS-3 : ci-invariants trop tardif — frontière A/B non testée avant M-CI-INVARIANTS.done

Les tests de frontière Couche A/B (analyse statique AST) n'étaient activés qu'après M-CI-INVARIANTS.done. La frontière A/B doit être vérifiée dès que le scoring existe (M-SCORING-ENGINE.done). Activation progressive requise : Phase 0 toujours actif, Phase 2+ (frontière A/B), Phase 4 (suite complète).

### FS-4 : Double CI (ci.yml + ci-main.yml) — redondance dangereuse

Deux workflows CI sur main créaient confusion, doublons de jobs et risque de divergence. Une seule CI unifiée (ci.yml) doit s'appliquer sur PR et push main.

### FS-5 : ci-format-black effectuait des commits automatiques

ADR-0001 §2.5 : la CI est arbitre, jamais auteur. Les autocommits Black masquent les écarts de format et violent la discipline. Règle : `black --check` uniquement ; en cas d'échec, le développeur formate localement et commit.

### FS-6 : ci-regenerate-freeze-checksums modifiait le freeze automatiquement

Le freeze est immuable. Régénérer les checksums en automatique (sur push/PR) permettrait de masquer des modifications non autorisées. Règle : workflow_dispatch uniquement, avec input de confirmation CTO obligatoire (saisie exacte "OUI").

### FS-7 : Tests triggers PostgreSQL absents de la CI

Les tests d'intégrité DB (triggers append-only, lock comité) n'étaient ni structurés ni exécutés dans la CI. La structure `tests/db_integrity/` et les paths correspondants doivent être définis et branchés dans ci.yml et ci-invariants.yml.

---

## §2 Décisions

### 2.1 Dictionnaire — couverture minimale Sahel (ADR-0002 §2.1)

Couverture minimale du dictionnaire procurement : 9 familles obligatoires (carburants, construction_liants, construction_agregats, construction_fer, vehicules, informatique, alimentation, medicaments, equipements). Minimum 5 items par famille, 3 aliases par item. Aliases critiques Sahel présents en DB après seed. Tests CI : `test_dict_minimum_coverage_all_families`, `test_critical_aliases_sahel_present_in_db`.

### 2.2 Market Signal — sans impact sur les scores (ADR-0002 §2.2)

INV-3 et §7 Constitution : la Couche B est strictement read-only vis-à-vis de la Couche A. Le Market Signal ne doit jamais modifier les scores. Règles MS-1 / MS-2 / MS-3 + dégradation (PARTIAL / DEGRADED). Test CI : `test_market_signal_has_zero_impact_on_supplier_scores`, `test_ms_*`.

### 2.3 Market Survey — règles terrain Sahel (ADR-0002 §2.3)

Règles SR-1 à SR-7 : minimum 3 cotations par item, zone géographique obligatoire, expiration 90 jours, validation par rôle buyer/admin. Tests CI : `test_sr1_minimum_3_cotations_per_item`, `test_sr2_zone_geographique_obligatoire`, `test_sr3_survey_expired_after_90_days`, `test_sr5_validation_requires_authorized_role`.

### 2.4 Frontière Couche A / Couche B — analyse statique AST (ADR-0002 §2.4)

Aucun module Couche B (market_signal, couche_b, market_survey, mercuriale, decision_history, context_panel, dict_fuzzy) ne peut être importé dans les chemins Couche A (scoring, normalisation, criteria, extraction, pipeline, committee, generation). Vérification par analyse AST des imports Python. Tests CI : `test_no_couche_b_import_in_couche_a` (test_couche_a_b_boundary.py), `test_scoring_module_has_no_couche_b_dependency`. Actifs dès M-SCORING-ENGINE.done.

### 2.5 SLA Classe A / B (ADR-0002 §2.5)

SLA-A : Pipeline Couche A (PDF natifs / XLSX / DOCX) < 60 s. SLA-B : OCR via queue, pas de blocage synchrone. Tests CI : `test_pipeline_a_sla_classe_a_under_60s`, `test_ocr_scan_is_queued_not_synchronous`, `test_ocr_does_not_block_native_pdf_processing`. Réf. §6.2 Constitution.

### 2.6 Triggers PostgreSQL — intégrité DB (ADR-0002 §2.6)

Triggers testés au niveau DB (psycopg2 raw, bypass API) : enforce_corrections_append_only (bloquer UPDATE/DELETE sur extraction_corrections), enforce_committee_lock (bloquer INSERT/UPDATE/DELETE sur committee_members si comité locked), prevent_committee_unlock. Structure `tests/db_integrity/` avec marqueur `@pytest.mark.db_integrity`. Intégration dans ci.yml (suite tests/) et ci-invariants.yml (Phase 0).

### 2.7 Doctrine d'échec — exports incomplets marqués (ADR-0002 §2.7)

§9 Constitution : exports incomplets = marqués (status=incomplete, raison explicite), jamais masqués. CBA sans scores → status incomplete. PV sans comité locked → non généré. Items à faible confiance (< 0.75) → flaggés dans le CBA. Tests CI : `test_incomplete_cba_returns_incomplete_status`, `test_pv_without_locked_committee_is_blocked`, `test_uncertain_items_flagged_in_cba_output`.

---

## §3 Alternatives rejetées

- Garder une gate coverage unique 40 % : incohérent avec la progression par phase.
- Laisser ci-main.yml actif en parallèle de ci.yml : redondance et risque de divergence.
- Autocommit Black en CI : contraire à ADR-0001 §2.5 (CI arbitre, pas auteur).
- Régénération automatique des checksums du freeze : viole l'immuabilité du freeze.
- Activer toute la suite invariants uniquement après M-CI-INVARIANTS.done : la frontière A/B doit être testée dès M-SCORING-ENGINE.done.
- Ne pas structurer les tests DB : les triggers sont le dernier rempart INV-6 ; ils doivent être dans la CI.

---

## §4 Conséquences

### 4.1 Milestones

Aucun nouvel ID de milestone créé. Les 28 IDs canoniques du plan V3.3.2 sont la référence unique. Les gates CI (coverage, invariants) s'alignent sur les phases déjà définies (M-DOCS-CORE, M-SCORING-ENGINE, M-SECURITY-CORE, M-CI-INVARIANTS).

### 4.2 Registre des tests (24 tests et squelettes)

| Domaine           | Fichier / tests                                                                 | Gate (milestone)           |
|-------------------|---------------------------------------------------------------------------------|---------------------------|
| invariants/phase0 | test_upload_magic_bytes, test_corrections_append_only, test_triggers_db_level   | M-DOCS-CORE / M-EXTRACTION-CORRECTIONS |
| invariants        | test_couche_a_b_boundary, test_no_couche_b_import_in_couche_a                   | M-SCORING-ENGINE.done     |
| db_integrity      | test_triggers_db_level, test_lock_committee_db_level                            | M-EXTRACTION-CORRECTIONS / M-COMMITTEE-CORE |
| normalisation     | test_no_raw_offer_in_scoring, test_dict_minimum_coverage, test_aliases_mandatory_sahel | M-NORMALISATION-ITEMS     |
| scoring           | test_scores_independent_of_couche_b, test_market_signal_no_impact_on_scores     | M-SCORING-ENGINE          |
| pipeline          | test_sla_classe_a_60s, test_sla_classe_b_has_queue                              | M-PIPELINE-A-E2E          |
| market_signal     | test_market_signal_rules, test_survey_validity                                  | M-MARKET-SIGNAL-ENGINE / M-MARKET-SURVEY-WORKFLOW |
| generation        | test_doctrine_echec_exports                                                    | M-CBA-GEN / M-PV-GEN      |

Tous les fichiers sont des squelettes valides (pytest.mark.skip + docstrings). Ils garantissent une CI verte immédiate tout en fixant le contrat pour les agents de build.

---

## §5 Notes anti-contournement

- Aucun workflow CI ne doit committer ou pusher du code (sauf ci-regenerate-freeze-checksums, dispatch + confirmation CTO "OUI").
- La liste des 28 milestones dans ci-milestones-gates.yml est canonique ; toute modification = ADR + validation CTO.
- Les chemins Couche A (COUCHE_A_PATHS) et modules Couche B (COUCHE_B_MODULES) dans test_couche_a_b_boundary.py sont figés par la Constitution §7.
- Ne pas réactiver ci-main.yml sans nouvel ADR.

---

## §6 Résolution des conflits CI (C-1 à C-7)

| Conflit | Résolution |
|---------|------------|
| **C-1** | ci-milestones-gates.yml réécrit avec les 28 IDs canoniques V3.3.2 dans l'ordre du plan. |
| **C-2** | Gate coverage progressive dans ci.yml : 0 % (phase init), 40 % (M-DOCS-CORE.done), 60 % (M-SCORING-ENGINE.done), 75 % (M-SECURITY-CORE.done). |
| **C-3** | ci-invariants.yml : Phase 0 (invariants fondamentaux + db_integrity) toujours actif ; Phase 2+ (frontière A/B) si M-SCORING-ENGINE.done ; Phase 4 (suite complète) si M-CI-INVARIANTS.done. |
| **C-4** | ci-main.yml supprimé ou remplacé par stub DEPRECATED (workflow_dispatch uniquement, message de fusion dans ci.yml). |
| **C-5** | ci-format-black.yml : black --check uniquement ; aucun git commit / git push. |
| **C-6** | ci-regenerate-freeze-checksums.yml : workflow_dispatch uniquement ; inputs reason (string) et cto_confirmation (exactement "OUI") ; échec si cto_confirmation != "OUI". |
| **C-7** | Structure tests/ créée (invariants/phase0, invariants, db_integrity, normalisation, scoring, pipeline, market_signal, generation). Paths configurés dans ci.yml (pytest tests/) et ci-invariants.yml (Phase 0 + Phase 2+ + Phase 4). |

---

## Statut final

- Cet ADR est ACCEPTÉ et prêt pour inclusion dans le freeze V3.3.2.
- Toute modification des workflows CI ou de la liste des milestones doit passer par un nouvel ADR et une validation CTO explicite.

_Fin ADR-0002._

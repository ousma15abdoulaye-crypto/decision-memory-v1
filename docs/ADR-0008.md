ADR-0008 â€” PROTOCOLE D'EXÃ‰CUTION MILITAIRE (V1.2)

Status : ACCEPTED â€” GEL IMMÃ‰DIAT
Date : 2026-02-22
DÃ©cideur : CTO (Abdoulaye Ousmane)
Contexte : Post M-CRITERIA-FK + M-NORMALISATION-ENGINE (DT-001/DT-002 liquidÃ©es)
OpposabilitÃ© : Tous milestones, tous agents (humains & IA), sans exception.

1) STATUT

ACCEPTED â€” GEL IMMÃ‰DIAT
Opposable sur tous les milestones, tous les agents.

2) CONTEXTE ET PROBLÃˆME

Les milestones M-CRITERIA-FK et M-NORMALISATION-ENGINE ont rÃ©vÃ©lÃ© trois pathologies rÃ©currentes :

Pathologie	Manifestation
Saut de sÃ©quence	Agent pose du code avant preuve DB / migrations
Contrat implicite	None retournÃ© lÃ  oÃ¹ un objet structurÃ© est requis
ClÃ´ture fantÃ´me	CI verte sans .done â‡’ milestone non opposable

Ces pathologies sont structurelles : sans protocole gravÃ©, un agent optimise localement et dÃ©grade globalement.

3) DÃ‰CISION

Le Protocole dâ€™ExÃ©cution Militaire V1.2 est la sÃ©quence canonique et obligatoire pour tout milestone DMS.

4) PROTOCOLE â€” TEXTE NORMATIF
4.1 â€” 8 Ã‰TAPES, AUCUN SAUT
Ã‰TAPE 0 â€” PrÃ©-flight (Reconnaissance terrain)

Obligatoire avant tout changement.

git status + git branch --show-current + git log -5

Get-ChildItem .milestones\

alembic heads + alembic current

pytest tests/ -q --tb=short

STOP immÃ©diat si :

alembic cassÃ© / incohÃ©rent

alembic heads > 1

tests rouges avant milestone (hors skips connus)

Exception contrÃ´lÃ©e (mandat fix/<...>) :
Si la branche est un correctif (fix/), les tests peuvent Ãªtre rouges au dÃ©part. Dans ce cas :
ğŸ›‘ STOP uniquement si le nombre de fails augmente, ou si un fail hors scope apparaÃ®t.

Ã‰TAPE 1 â€” Branche + Preuve DB (preuve, pas intuition)

git checkout -b feat/<MILESTONE> (ou fix/<...> si correctif)

ExÃ©cuter une preuve DB (psycopg direct) contre information_schema et/ou pg_catalog

DB-PROOF-001 â€” preuve DB minimale obligatoire :

Ã©tat migrations : alembic heads/current

existence des tables du milestone (schema + table)

contraintes concernÃ©es (FK/UNIQUE/CHECK)

index attendus (ou absence assumÃ©e)

seed/coverage si milestone dict/normalisation

STOP si la DB contredit le plan â‡’ remonter CTO avant tout code.

Ã‰TAPE 2 â€” DÃ©cision migration (Alembic)

RÃ¨gle :

Si DB conforme â†’ aucune migration

Si DB non conforme â†’ migration obligatoire

Commandes :

VÃ©rifier revision_id â‰¤ 32 chars avant upgrade (ALEMBIC-001)

alembic upgrade head â†’ alembic current â†’ alembic heads

STOP si :

erreur Alembic

head multiple

ID > 32 chars

chaÃ®ne incohÃ©rente

Ã‰TAPE 3 â€” Tests DB-level (invariants DB avant API)

pytest tests/db_integrity -q --tb=short

STOP si rouge.
Aucun endpoint / router nâ€™est touchÃ© tant que DB-level nâ€™est pas vert.

Ã‰TAPE 4 â€” Service (logique mÃ©tier minimale)

SQL paramÃ©trÃ© uniquement (SQL-001)

Doctrine dâ€™Ã©chec : jamais catch-all

ZÃ©ro import Couche B dans modules dÃ©cisionnels Couche A (ADR-0002)

Ã‰TAPE 5 â€” Router / API

ForeignKeyViolation discriminÃ©e (jamais catch-all)

Le router ne ment jamais sur la cause (case vs canonical_item vs autre)

Ã‰TAPE 6 â€” Tests ciblÃ©s milestone

pytest tests/api/test_<milestone>.py -v --tb=short (ou tests normalisation dÃ©diÃ©s)

STOP si rouge.

Ã‰TAPE 7 â€” Suite complÃ¨te + clÃ´ture

VÃ©ritÃ© finale (obligatoire) :

pytest tests/ -q --tb=short â†’ 0 failed

ruff check src tests â†’ All checks passed

black --check src tests â†’ unchanged

Puis seulement :

CrÃ©er .milestones/<MILESTONE>.done

git add fichier par fichier (STAGING-001)

git diff --cached --stat (preuve scope)

git commit + git push + PR

4.2 â€” RÃˆGLES PERMANENTES (CANONIQUES)
ID	RÃ¨gle	Contenu
ALEMBIC-001	revision_id	â‰¤ 32 chars â€” vÃ©rifier avant upgrade
CONFTEST-001	TESTING flag	TESTING=true avant tout import src.* dans tests
STAGING-001	git add	fichier par fichier â€” git add . interdit
SEED-001	ON CONFLICT	ON CONFLICT (col_exacte) DO NOTHING â€” jamais vague
SCHEMA-001	FK cross-schema	rÃ©fÃ©rence explicite schema.table(col)
SQL-001	SQL paramÃ©trÃ©	jamais f-string avec user input
ARCH-001	AutoritÃ© donnÃ©es	moteur adossÃ© Ã  une autoritÃ© de donnÃ©es â†’ Couche B
ARCH-001clar	AutoritÃ© â‰  dossier	ARCH-001 fixe lâ€™autoritÃ© (DB Couche B), pas le rÃ©pertoire. La localisation du code est libre tant que ADR-0002 est respectÃ© (pas dâ€™import Couche B dans Couche A; lecture SQL paramÃ©trÃ©e OK).
ARCH-001bis	Couplage autorisÃ©	Couche A peut rÃ©fÃ©rencer Couche B uniquement via contraintes DB (FK) ou lecture SQL paramÃ©trÃ©e. Interdit : importer modules Python Couche B, ou faire dÃ©pendre la logique dÃ©cisionnelle (scoring) dâ€™une mÃ©moire Couche B.
ARCH-002	Signature retour	rÃ©sultat mÃ©tier exposÃ© = toujours objet structurÃ© â€” jamais None
ARCH-002bis	Scope â€œjamais Noneâ€	sâ€™applique aux rÃ©sultats mÃ©tier exposÃ©s (API/pipeline/normalisation/scoring). Helpers internes peuvent retourner None seulement si jamais sÃ©rialisÃ©s, jamais franchissement de frontiÃ¨re.
ARCH-003	SchÃ©mas inter-couches	Pydantic obligatoire dÃ¨s quâ€™un rÃ©sultat traverse une frontiÃ¨re
GIT-LOCK-001	index.lock	si .git/index.lock existe â†’ STOP, kill processus git/python, supprimer lock, reprendre
4.3 â€” TECHNIQUE Dâ€™ISOLATION C1/C2/C3

C1 : Liste exacte des fails

--tb=no + Select-String FAILED|ERROR

C2 : Test A/B â€œprÃ©-existantâ€

main vs branche, DB cohÃ©rente (pas de DB â€œavancÃ©eâ€ localement)

C3 : Patch minimal

Une cause, un patch

Jamais refactor, jamais skip

4.4 â€” DÃ‰FINITION OF DONE (IMMUABLE)

âœ… alembic current = head attendu
âœ… Gates milestone = verts
âœ… pytest tests/ = 0 failed
âœ… ruff + black = clean
âœ… .milestones/<MILESTONE>.done prÃ©sent et complet
âœ… git diff --cached --stat = scope exact
âœ… PR ouverte â€” merge interdit sans review CTO

DONE-001 â€” Contenu minimal .done obligatoire :

milestone_id

date

branch

commit_sha

db_head (sortie alembic heads)

tests (passed/failed/skipped + preuve 0 failed)

ruff (pass/fail)

black (pass/fail)

files (liste exacte git diff --cached --name-only)

verdict : DONE (binaire)

4.5 â€” SIGNAUX Dâ€™ARRÃŠT UNIVERSELS

ğŸ›‘ alembic heads > 1
ğŸ›‘ tests rouges avant milestone (hors skips connus)
ğŸ›‘ DB contredit le plan
ğŸ›‘ pytest tests/ repasse au-dessus de 0 failed
ğŸ›‘ un service mÃ©tier exposÃ© retourne None
ğŸ›‘ surprise non couverte par mandat â†’ remonter CTO

5) CONSÃ‰QUENCES
Positives

Chaque milestone est auditable sans contexte verbal

Les .done deviennent un journal cumulatif dâ€™opposabilitÃ©

Les agents ne peuvent plus optimiser localement au dÃ©triment du systÃ¨me

NÃ©gatives acceptÃ©es

SÃ©quence plus longue quâ€™un â€œquick fixâ€

PrÃ©-flight obligatoire mÃªme sur milestone trivial

Non-consÃ©quences

Ne remplace pas ADR-0001/ADR-0002

Ne dÃ©finit pas lâ€™architecture : dÃ©finit comment exÃ©cuter

6) ALTERNATIVES REJETÃ‰ES
Alternative	Raison du rejet
Protocole optionnel selon complexitÃ©	crÃ©e jugement local â‡’ dÃ©grade globalement
Pas de .done sur milestones sans migration	.done = opposabilitÃ©, pas preuve de migration
None autorisÃ© sur UNRESOLVED	muet, non traÃ§able, non auditable
â€œOn skip pour avancerâ€	masque dette, casse invariants
7) FORMULE GRAVÃ‰E

"On ne fait pas passer les tests. On contraint le systÃ¨me jusqu'Ã  ce qu'il n'ait plus d'autre choix."
â€” CTO, DMS V3.3.2

8) RÃ‰FÃ‰RENCES

ADR-0001 : Architecture Couche A / Couche B

ADR-0002 : FrontiÃ¨res et contrats inter-couches

M-CRITERIA-FK : origine DT-001 + guard alembic multi-head

M-NORMALISATION-ENGINE : origine DT-002 (ARCH-001/002/003)

Ã‰TAT GLOBAL â€” POST ADR-0008

Constitution : V3.3.2

ADR actifs : 0001 âœ… | 0002 âœ… | 0008 âœ… (GELÃ‰)

Protocole exec : Militaire V1.2 â€” ADR-0008 âœ…

DB head : 023_m_criteria_fk

CI : pytest tests/ = 0 failed (compteurs passed/skipped informatifs)

DT-001 : âœ… LIQUIDÃ‰E

DT-002 : âœ… LIQUIDÃ‰E

DT-003 : ACTIVE â€” prochaine cible

ADR-0008 : GELÃ‰.

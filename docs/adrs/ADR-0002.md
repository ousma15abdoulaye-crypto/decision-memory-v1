# ADR-0002 â€” BÃ©tonisation des Milestones V3.3.2 : Dictionnaire Procurement, Couche B Moat, SÃ©curitÃ© SystÃ©mique & Standard Sahel

---

```
Status:        ACCEPTED
Date:          2026-02-16
Author:        Abdoulaye Ousmane (Founder & CTO)
Constitution:  V3.3.2 (canonique)
PrÃ©cÃ©dent:     ADR-0001 (fusion M10-UX + M-SECURITY-CORE)
Scope:         BÃ©tonisation niveau standard â€” non refonte
Objectif:      Rendre les milestones le bras armÃ© quasi bÃ©ton
               de la Constitution V3.3.2
Related:
  docs/CONSTITUTION_DMS_V3.3.2.md
  docs/MILESTONES_EXECUTION_PLAN_V3.3.2.md
  docs/adrs/ADR-0001.md
  docs/freeze/v3.3.2/FREEZE_MANIFEST.md
```

---

## 1. Contexte & Diagnostic CTO

### 1.1 â€” Ce que l'ADR-0001 a rÃ©solu

ADR-0001 a rÃ©glÃ© les problÃ¨mes **structurels** :
- Fusion registre dÃ©pÃ´t â†’ M10-UX-V2 âœ…
- CrÃ©ation M-SECURITY-CORE distinct âœ…
- Market Signal dÃ©clarÃ© bloquant GO production âœ…
- Dictionnaire non contournable dÃ©clarÃ© âœ…
- Discipline agents imposÃ©e âœ…

### 1.2 â€” Ce qui reste insuffisant pour un standard Sahel

En tant que CTO senior + Procurement Analyst, je diagnostique **7 failles systÃ©miques** que ADR-0001 n'a pas fermÃ©es :

| ID | Faille | Couche | Impact |
|----|--------|--------|--------|
| **FS-1** | Dictionnaire dÃ©clarÃ© "non contournable" mais non seedÃ©, non structurÃ©, sans couverture minimale opposable | B | Moat inexistant au lancement |
| **FS-2** | Market Survey workflow dÃ©crit mais sans rÃ¨gles de collecte terrain opposables pour le Sahel | B | Signal non reprÃ©sentatif, adoption bloquÃ©e |
| **FS-3** | FrontiÃ¨re A/B dÃ©clarÃ©e mais non testÃ©e par analyse statique d'imports | A/B | Â§7 violable silencieusement |
| **FS-4** | SLA non diffÃ©renciÃ© OCR vs natif dans les gates CI | A | Promesse non tenue sur scans terrain |
| **FS-5** | Triggers PostgreSQL (LOCK comitÃ©, corrections append-only) dÃ©clarÃ©s mais sans tests DB-level dans CI | A | INV-6 violable |
| **FS-6** | Doctrine d'Ã©chec Â§9 sans gate CI : exports incomplets non dÃ©tectÃ©s | A | Non-conformitÃ© silencieuse |
| **FS-7** | RÃ¨gles de prÃ©dominance des 3 sources Market Signal non spÃ©cifiÃ©es de faÃ§on opposable | B | AgrÃ©gation arbitraire |

---

## 2. DÃ©cisions

### 2.1 â€” BÃ©tonisation M-NORMALISATION-ITEMS : Dictionnaire Procurement Sahel

#### DÃ©cision

Le dictionnaire procurement passe du statut "prÃ©vu" au statut **composant critique seedÃ© au dÃ©ploiement**. Il constitue le **premier pilier du moat Couche B**.

#### Couverture minimale opposable

Le dictionnaire doit couvrir **au minimum** les familles suivantes avant tout GO production :

```
FAMILLES OBLIGATOIRES (couverture minimale GO production)

  Famille 1 : Carburants & Ã‰nergie
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : gasoil, essence super, pÃ©trole lampant,
          gaz butane 6kg, gaz butane 12kg,
          charbon de bois sac 100kg
  UnitÃ©s : litre, kg, unitÃ©
  CriticitÃ© : CRITIQUE â€” tout processus minier,
              ONG terrain, Ã‰tat utilise ces items
  
  Famille 2 : Construction â€” Liants hydrauliques
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : ciment CPA 42.5, ciment CPA 32.5,
          ciment M 32.5 R, plÃ¢tre d'importation,
          ciment colle
  UnitÃ©s : tonne, sac 50kg
  CriticitÃ© : CRITIQUE â€” DAO infrastructures
  
  Famille 3 : Construction â€” AgrÃ©gats
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : sable fleuve, gravier 10/14, gravier 6/10,
          latÃ©rite, tout venant, moellon
  UnitÃ©s : 7mÂ³ (voyage), mÂ³, tonne
  CriticitÃ© : CRITIQUE â€” conversions voyage/mÂ³
              source principale d'erreur terrain
  
  Famille 4 : Construction â€” Fer & ProfilÃ©s
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : fer HA 8mm, fer HA 10mm, fer HA 12mm,
          fer HA 16mm, fer HA 20mm,
          corniÃ¨re 40Ã—40, IPN 100
  UnitÃ©s : barre 12m, kg, tonne
  CriticitÃ© : HAUTE â€” DAO bÃ¢timent, routes
  
  Famille 5 : VÃ©hicules & Deux-roues
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : Toyota Land Cruiser 4Ã—4 HZJ78,
          Toyota Hilux DC 4Ã—4 diesel,
          moto Jakarta 125cc,
          moto TVS 125cc
  UnitÃ©s : unitÃ©
  CriticitÃ© : HAUTE â€” ONG, mines, Ã‰tat
  
  Famille 6 : Informatique & Bureautique
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : ordinateur portable Core i5 8Go 512SSD,
          imprimante laser HP 107W,
          photocopieuse Canon IR 2520,
          onduleur 1000VA,
          papier A4 80g
  UnitÃ©s : unitÃ©, rame
  CriticitÃ© : HAUTE â€” tout appel d'offres bureau
  
  Famille 7 : Alimentation
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : riz gambiaka 100kg, riz parfumÃ© 5kg,
          huile vÃ©gÃ©tale 20L, sucre poudre 50kg,
          mil 100kg, lait Nido 400g,
          eau minÃ©rale 1.5L carton
  UnitÃ©s : sac, bidon, carton, unitÃ©
  CriticitÃ© : HAUTE â€” PAM, ONG humanitaire, Ã‰tat
  
  Famille 8 : MÃ©dicaments & MatÃ©riel mÃ©dical
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : paracetamol 500mg cp boÃ®te/100,
          amoxicilline 500mg gel boÃ®te/12,
          SRO sachet boÃ®te/20,
          sÃ©rum physiologique 500ml,
          gants chirurgicaux stÃ©riles 7.5,
          cathÃ©ter IV G18,
          seringue 5ml avec aiguille
  UnitÃ©s : boÃ®te, unitÃ©, paire
  CriticitÃ© : CRITIQUE â€” MinistÃ¨re SantÃ©,
              ONG santÃ©, UNFPA, UNICEF
  
  Famille 9 : Ã‰quipements techniques
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Items : groupe Ã©lectrogÃ¨ne 15 KVA Perkins,
          groupe Ã©lectrogÃ¨ne 10 KVA,
          climatiseur split 1.5 CV,
          panneau solaire 250W,
          pompe solaire immergÃ©e
  UnitÃ©s : unitÃ©
  CriticitÃ© : HAUTE â€” mines, ONG terrain,
              projets ruraux
```

#### Aliases obligatoires (minimum seedÃ©)

```python
# Critique: erreurs terrain les plus frÃ©quentes
# Source: mercuriale Bamako 2023 + retours terrain Mali

ALIASES_MANDATORY_SAHEL = {

    # â”€â”€â”€ Carburants (terrain Sahel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "gasoil": [
        "gas oil", "diesel", "gaz oil", "gazole",
        "GO", "gasoil ordinaire", "carburant diesel",
        "fuel diesel", "gazoil"
    ],
    "essence super": [
        "essence", "super", "SP95", "SP",
        "carburant essence", "pÃ©trole blanc",
        "essence ordinaire"
    ],
    "pÃ©trole lampant": [
        "pÃ©trole", "kerosene", "kÃ©rosÃ¨ne",
        "lampant", "petroleum"
    ],

    # â”€â”€â”€ Construction (confusions volumes/poids) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "sable fleuve 7m3": [
        "sable du fleuve", "sable riviÃ¨re",
        "sable naturel", "sable de fleuve",
        "sable voyage", "sable 7m3",
        "sable (voyage camion)"
    ],
    "gravier 10/14 7m3": [
        "gravier concassÃ© 10/14", "gravier 10-14",
        "gravillon 10/14", "gravier carriÃ¨re",
        "gravier voyage", "gravier 7m3"
    ],
    "ciment CPA 42.5": [
        "ciment 42.5", "CPA42,5", "ciment Portland 42.5",
        "ciment ordinaire 42.5", "ciment 42,5 R",
        "CPJ 42.5", "ciment gris 42.5",
        "CPA 42,5 R", "ciment Portland 42,5"
    ],
    "fer HA 12mm barre 12m": [
        "rond tor 12", "HA 12", "HA12",
        "acier 12mm", "barre 12mm",
        "fer 12", "tor 12", "HA 12mm",
        "rond 12", "Ã˜12"
    ],
    "fer HA 10mm barre 12m": [
        "rond tor 10", "HA 10", "HA10",
        "acier 10mm", "fer 10", "tor 10", "Ã˜10"
    ],

    # â”€â”€â”€ VÃ©hicules (variantes nomenclature) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "Toyota Land Cruiser 4x4 HZJ78": [
        "Land Cruiser 78", "LC 78", "LandCruiser HZJ78",
        "Toyota 78", "LC78 HZJ", "Landcruiser diesel 4x4"
    ],
    "Toyota Hilux DC 4x4 diesel": [
        "Hilux double cabine", "Hilux 4x4",
        "Toyota Hilux", "Hilux DC diesel",
        "pickup Toyota 4x4", "hilux dc 4x4"
    ],
    "moto Jakarta 125cc": [
        "Jakarta 125", "moto Jakarta",
        "Djakarta 125cc", "moto 125 Jakarta",
        "jakarta moto"
    ],

    # â”€â”€â”€ Informatique (marques vs gÃ©nÃ©riques) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "papier photocopie A4 80g": [
        "papier A4", "rame A4", "papier A4 80g",
        "papier bureau", "rame photocopie",
        "papier impression A4", "rame 80g",
        "papier duplicateur A4"
    ],
    "imprimante laser HP LaserJet": [
        "imprimante HP", "HP laser", "LaserJet",
        "HP laserjet", "imprimante laser",
        "imprimante laser noir"
    ],

    # â”€â”€â”€ MÃ©dicaments (DCI vs marque) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "paracetamol 500mg comprimÃ©": [
        "doliprane 500", "efferalgan 500",
        "paracet 500", "paracetamol 500",
        "paracetamol 500 cp", "para 500",
        "Doliprane", "Efferalgan"
    ],
    "amoxicilline 500mg gÃ©lule": [
        "amoxicil 500", "amodex 500",
        "clamoxyl 500", "amoxicilline 500",
        "Amoxicilline 500mg", "amoxi 500",
        "Clamoxyl 500mg"
    ],
    "solution de rÃ©hydratation orale sachet": [
        "SRO", "sels de rÃ©hydratation",
        "rÃ©hydratation orale", "ORS",
        "sachet SRO"
    ],

    # â”€â”€â”€ Alimentation (sacs, bidons, conditionnements) â”€â”€â”€â”€â”€â”€â”€â”€
    "riz gambiaka sac 100kg": [
        "riz local 100kg", "riz gambiaka",
        "Gambiaka 100kg", "riz blanc local 100kg"
    ],
    "huile vÃ©gÃ©tale litre": [
        "huile de cuisine", "huile alimentaire",
        "huile vÃ©gÃ©tale comestible", "huile",
        "huile raffinÃ©e", "Dinor", "AYA",
        "huile vÃ©gÃ©tale 1L"
    ],
    "sucre en poudre sac 50kg": [
        "sucre 50kg", "sucre blanc 50kg",
        "sucre granulÃ© 50kg", "sucre poudre"
    ],

    # â”€â”€â”€ Ã‰quipements (confusion KVA/KW) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "groupe Ã©lectrogÃ¨ne 15 KVA Perkins": [
        "GE 15KVA", "groupe 15kva",
        "groupe Ã©lectrogÃ¨ne 15kva Perkins",
        "groupe 15 KVA", "genset 15KVA",
        "gÃ©nÃ©rateur 15 KVA"
    ],
    "groupe Ã©lectrogÃ¨ne 10 KVA": [
        "GE 10KVA", "groupe 10kva",
        "groupe Ã©lectrogÃ¨ne 10kva",
        "groupe 10 KVA", "genset 10KVA"
    ]
}
```

#### Conversions d'unitÃ©s critiques (Sahel)

```python
# Conversions sources d'erreur terrain documentÃ©es
UNIT_CONVERSIONS_MANDATORY = {
    # Construction (voyage â‰  mÂ³ â‰  tonne)
    ("voyage_camion_7m3", "m3"):    7.0,
    ("voyage_bachee_7m3", "m3"):    7.0,
    ("sac_50kg",          "tonne"): 0.05,
    ("sac_50kg",          "kg"):    50.0,
    ("barre_12m",         "ml"):    12.0,
    
    # Alimentation
    ("sac_100kg",  "kg"):    100.0,
    ("sac_50kg",   "kg"):    50.0,
    ("carton_24u", "unite"): 24.0,
    ("carton_12u", "unite"): 12.0,
    
    # Carburants
    ("baril_200L", "litre"): 200.0,
    ("fut_200L",   "litre"): 200.0,
    
    # MÃ©dical
    ("boite_100cp",  "unite"):   100.0,
    ("boite_12gelu", "unite"):   12.0,
    ("boite_20sach", "unite"):   20.0,
}
```

#### Gate CI dictionnaire

```python
# tests/normalisation/test_dict_minimum_coverage.py
# ðŸ”´ BLOQUE CI si couverture insuffisante

MANDATORY_FAMILIES = [
    "carburants", "construction_liants", "construction_agregats",
    "construction_fer", "vehicules", "informatique",
    "alimentation", "medicaments", "equipements"
]

MINIMUM_ITEMS_PER_FAMILY = 5
MINIMUM_ALIASES_PER_ITEM = 3

def test_dict_minimum_coverage():
    """
    Garantit que le dictionnaire est suffisamment riche
    pour couvrir les cas d'usage Sahel.
    ðŸ”´ BLOQUE CI si non respectÃ©.
    """
    for family in MANDATORY_FAMILIES:
        items = get_items_by_family(family)
        assert len(items) >= MINIMUM_ITEMS_PER_FAMILY, (
            f"Famille '{family}': {len(items)} items "
            f"< minimum {MINIMUM_ITEMS_PER_FAMILY}"
        )
        for item in items:
            aliases = get_aliases(item.id)
            assert len(aliases) >= MINIMUM_ALIASES_PER_ITEM, (
                f"Item '{item.label_canonical}': "
                f"{len(aliases)} aliases "
                f"< minimum {MINIMUM_ALIASES_PER_ITEM}"
            )
```

---

### 2.2 â€” BÃ©tonisation M-MARKET-SIGNAL-ENGINE : RÃ¨gles de prÃ©dominance opposables (FS-7)

#### DÃ©cision

Les rÃ¨gles de prÃ©dominance des 3 sources sont gelÃ©es de faÃ§on **opposable et implÃ©mentable**.

#### RÃ¨gles canoniques

```
RÃˆGLE MS-1 â€” Market Survey terrain (Source 1, prioritÃ© maximale)
  Condition d'activation :
    - date_survey â‰¤ 90 jours depuis date_processus
    - nb_cotations_item â‰¥ 3
    - zone_survey == zone_processus (ou zone parente validÃ©e)
    - statut_survey == 'validated' (validÃ© par responsable)
  Si activÃ©e :
    - price_reference = mÃ©diane des cotations terrain
    - confidence = 'high'
    - signal_label = 'TERRAIN_FRESH'

RÃˆGLE MS-2 â€” Historique des dÃ©cisions (Source 2, prioritÃ© intermÃ©diaire)
  Condition d'activation :
    - Au moins 1 dÃ©cision en DB pour cet item canonique
    - dans la mÃªme zone (ou zone parente)
    - dans les 24 derniers mois
  Si activÃ©e (et MS-1 non activÃ©e) :
    - price_reference = mÃ©diane des prix payÃ©s (24 mois)
    - price_trend = (prix_moyen_12m - prix_moyen_24m) / prix_moyen_24m
    - confidence = 'medium'
    - signal_label = 'HISTORY_24M'

RÃˆGLE MS-3 â€” Mercuriale officielle (Source 3, borne rÃ©glementaire)
  Toujours disponible si item dans mercuriale.
  RÃ´le : borne supÃ©rieure (prix plafond rÃ©glementaire).
  Ne remplace jamais MS-1 ni MS-2.
  confidence = 'regulatory'
  signal_label = 'MERCURIALE_OFFICIAL'

RÃˆGLE MS-DEGRADE â€” DÃ©gradation (informatif, jamais bloquant scoring)
  3 sources actives â†’ signal_quality = 'COMPLETE'    âœ…
  2 sources actives â†’ signal_quality = 'PARTIAL'     âš ï¸
  1 source active  â†’ signal_quality = 'DEGRADED'    ðŸ”´
  0 source active  â†’ signal_quality = 'UNAVAILABLE' â¬›

RÃˆGLE MS-ZERO â€” Interdiction absolue
  Le MarketSignalEngine ne peut jamais :
    - Modifier supplier_scores
    - Appeler scoring_engine
    - Ã‰crire dans les tables Couche A
    - Ã‰mettre une recommandation (INV-3)
  Test CI bloquant : test_market_signal_read_only_couche_a.py
```

---

### 2.3 â€” BÃ©tonisation M-MARKET-SURVEY-WORKFLOW : RÃ¨gles terrain Sahel (FS-2)

#### DÃ©cision

Le workflow Market Survey est bÃ©tonisÃ© avec des rÃ¨gles terrain adaptÃ©es au contexte Mali/Sahel.

```
RÃˆGLES MARKET SURVEY â€” STANDARD SAHEL

  SR-1 : Minimum 3 cotations par item canonique
         (pas par ligne brute â€” aprÃ¨s normalisation)

  SR-2 : Zone gÃ©ographique obligatoire
         Valeurs : district | cercle | rÃ©gion | national
         Raison : les prix varient fortement entre Bamako
                  et les zones pÃ©riphÃ©riques (Kidal, MÃ©naka)

  SR-3 : Date de collecte obligatoire
         ValiditÃ© : 90 jours depuis la date de collecte
         Au-delÃ  : survey marquÃ© 'expired', non utilisable
                   dans Market Signal

  SR-4 : Source de la cotation obligatoire
         Valeurs : fournisseur_local | grossiste | 
                   prix_marche_central | importateur |
                   autre (avec justification)

  SR-5 : Validateur humain obligatoire
         Le survey ne passe pas en 'validated' sans
         validation explicite d'un responsable procurement
         (RBAC : rÃ´le buyer ou admin)

  SR-6 : CohÃ©rence de la devise
         Devise par dÃ©faut : XOF
         Si USD ou EUR : conversion automatique
         avec taux BCE du jour de collecte (ou taux saisi)

  SR-7 : Gate GO production
         Un processus ne peut pas passer en 'evaluation'
         si le Market Signal est UNAVAILABLE pour
         les items Ã  enjeu financier > seuil_alerte
         (configurable par organisation)
         NB : gate informatif, non bloquant pour scoring
```

---

### 2.4 â€” BÃ©tonisation frontiÃ¨re A/B : test par analyse statique (FS-3)

#### DÃ©cision

La frontiÃ¨re Â§7 est vÃ©rifiÃ©e **par analyse statique des imports** Ã  chaque CI, pas seulement par tests unitaires.

```python
# tests/invariants/test_couche_a_b_boundary.py
# ðŸ”´ BLOQUE CI si violation

import ast
import os
from pathlib import Path

# Modules Couche B â€” aucun ne peut Ãªtre importÃ© dans Couche A
COUCHE_B_MODULES = [
    'market_signal',
    'couche_b',
    'market_survey',
    'mercuriale',
    'decision_history',
    'context_panel',
    'dict_fuzzy',
]

# Modules Couche A â€” oÃ¹ la violation est interdite
COUCHE_A_PATHS = [
    'app/scoring/',
    'app/normalisation/',
    'app/criteria/',
    'app/extraction/',
    'app/pipeline/',
    'app/committee/',
    'app/generation/',
]

def test_no_couche_b_import_in_couche_a():
    """
    Â§7 : La Couche B est strictement read-only
    vis-Ã -vis de la Couche A.
    VÃ©rifiÃ© par analyse statique (AST).
    ðŸ”´ BLOQUE CI si violation.
    """
    violations = []

    for couche_a_path in COUCHE_A_PATHS:
        for py_file in Path(couche_a_path).rglob('*.py'):
            with open(py_file) as f:
                try:
                    tree = ast.parse(f.read())
                except SyntaxError:
                    continue

            for node in ast.walk(tree):
                if isinstance(node, (ast.Import, ast.ImportFrom)):
                    module = getattr(node, 'module', '') or ''
                    names = [
                        alias.name for alias in
                        getattr(node, 'names', [])
                    ]
                    all_names = [module] + names

                    for forbidden in COUCHE_B_MODULES:
                        for name in all_names:
                            if forbidden in name.lower():
                                violations.append({
                                    'file': str(py_file),
                                    'line': node.lineno,
                                    'import': name,
                                    'forbidden': forbidden
                                })

    assert not violations, (
        f"VIOLATION Â§7 â€” {len(violations)} import(s) "
        f"Couche B dÃ©tectÃ©(s) dans Couche A :\n"
        + '\n'.join(
            f"  {v['file']}:{v['line']} "
            f"â†’ import '{v['import']}' "
            f"(module interdit: '{v['forbidden']}')"
            for v in violations
        )
    )
```

---

### 2.5 â€” BÃ©tonisation SLA : deux classes opposables en CI (FS-4)

#### DÃ©cision

Deux gates CI distincts remplacent le SLA unique.

```python
# tests/pipeline/test_sla_classe_a.py
# ðŸ”´ BLOQUE CI si > 60s sur documents natifs

import time
import pytest

@pytest.mark.slow
def test_sla_classe_a_pdf_native(realistic_case_20_suppliers):
    """
    SLA-A : PDF natifs, XLSX, DOCX â†’ < 60s
    Fixture : case rÃ©aliste, 20+ fournisseurs, 10+ lots
    ðŸ”´ BLOQUE CI si dÃ©passement.
    """
    start = time.monotonic()
    result = run_pipeline_a(
        case_id=realistic_case_20_suppliers.id,
        doc_types=['pdf_native', 'xlsx', 'docx']
    )
    elapsed = time.monotonic() - start

    assert result.status in ('complete', 'incomplete_flagged'), (
        f"Pipeline A Ã©chouÃ© : {result.status}"
    )
    assert elapsed < 60.0, (
        f"SLA-A violÃ© : {elapsed:.2f}s > 60s. "
        f"Optimiser extraction ou rÃ©duire scope. "
        f"(SLA-A cible : PDF natifs / XLSX / DOCX)"
    )


# tests/pipeline/test_sla_classe_b.py
def test_sla_classe_b_ocr_has_queue(scan_document_fixture):
    """
    SLA-B : Scans OCR â†’ queue + progress + statut.
    VÃ©rifie que l'OCR ne bloque PAS le thread principal.
    """
    doc_id = upload_scan_document(scan_document_fixture)

    # L'endpoint upload rÃ©pond immÃ©diatement
    status = get_document_status(doc_id)
    assert status in ('pending', 'processing'), (
        "Le scan OCR doit Ãªtre mis en queue, "
        "pas traitÃ© synchronement."
    )

    # Le statut est consultable
    progress = get_extraction_progress(doc_id)
    assert 'status' in progress
    assert 'estimated_completion' in progress


def test_sla_classe_b_ocr_does_not_block_app(
    scan_document_fixture,
    another_native_pdf_fixture
):
    """
    SLA-B : Un scan OCR en cours ne bloque pas
    le traitement d'un PDF natif simultanÃ©.
    """
    ocr_doc_id = upload_scan_document(scan_document_fixture)
    
    start = time.monotonic()
    native_result = run_pipeline_a_single_doc(another_native_pdf_fixture)
    elapsed = time.monotonic() - start

    assert elapsed < 60.0, (
        f"PDF natif bloquÃ© par OCR en cours : {elapsed:.2f}s"
    )
    assert native_result.status != 'blocked'
```

---

### 2.6 â€” BÃ©tonisation triggers PostgreSQL en CI (FS-5)

#### DÃ©cision

Les triggers PostgreSQL sont **testÃ©s directement contre la DB de test** dans CI, pas seulement via les endpoints.

```python
# tests/db_integrity/test_triggers_db_level.py
# ðŸ”´ TOUS BLOQUANTS CI

import pytest
from psycopg2 import errors as pg_errors

class TestAppendOnlyTrigger:
    """
    VÃ©rifie que le trigger enforce_corrections_append_only
    est actif au niveau DB (pas seulement via API).
    """

    def test_trigger_blocks_update_directly(self, db_conn, sample_correction):
        """ðŸ”´ BLOQUE CI"""
        with pytest.raises(Exception) as exc_info:
            db_conn.execute(
                "UPDATE extraction_corrections "
                "SET reason = 'tampered' WHERE id = %s",
                (sample_correction.id,)
            )
        assert 'append-only' in str(exc_info.value).lower() or \
               'INV-6' in str(exc_info.value), (
            "Le trigger doit mentionner 'append-only' ou 'INV-6'"
        )

    def test_trigger_blocks_delete_directly(self, db_conn, sample_correction):
        """ðŸ”´ BLOQUE CI"""
        with pytest.raises(Exception):
            db_conn.execute(
                "DELETE FROM extraction_corrections WHERE id = %s",
                (sample_correction.id,)
            )


class TestCommitteeLockTrigger:
    """
    VÃ©rifie que le trigger enforce_committee_lock
    est actif au niveau DB.
    """

    def test_trigger_blocks_member_insert_after_lock(
        self, db_conn, locked_committee
    ):
        """ðŸ”´ BLOQUE CI"""
        with pytest.raises(Exception) as exc_info:
            db_conn.execute(
                "INSERT INTO committee_members "
                "(committee_id, role, last_name, first_name) "
                "VALUES (%s, 'observer', 'Test', 'User')",
                (locked_committee.id,)
            )
        assert 'verrouillÃ©' in str(exc_info.value).lower() or \
               'INV-6' in str(exc_info.value)

    def test_trigger_blocks_member_update_after_lock(
        self, db_conn, locked_committee
    ):
        """ðŸ”´ BLOQUE CI"""
        member = get_first_member(locked_committee.id)
        with pytest.raises(Exception):
            db_conn.execute(
                "UPDATE committee_members "
                "SET function = 'tampered' WHERE id = %s",
                (member.id,)
            )

    def test_trigger_blocks_committee_unlock(
        self, db_conn, locked_committee
    ):
        """ðŸ”´ BLOQUE CI"""
        with pytest.raises(Exception) as exc_info:
            db_conn.execute(
                "UPDATE committees SET status = 'draft' WHERE id = %s",
                (locked_committee.id,)
            )
        assert 'dÃ©verrouillÃ©' in str(exc_info.value).lower() or \
               'INV-6' in str(exc_info.value)
```

---

### 2.7 â€” BÃ©tonisation doctrine d'Ã©chec Â§9 : gate CI exports (FS-6)

#### DÃ©cision

Les exports incomplets sont **dÃ©tectÃ©s et signalÃ©s explicitement** avec gate CI.

```python
# tests/generation/test_doctrine_echec_exports.py

class TestDoctrinEchecCBA:
    """
    Â§9 : Exports incomplets = marquÃ©s comme tels.
    Calculs incertains = signalÃ©s.
    PV douteux = non gÃ©nÃ©rÃ©s.
    """

    def test_incomplete_cba_marked_not_silenced(
        self, case_with_missing_scores
    ):
        """
        Un CBA avec scores manquants doit Ãªtre marquÃ©
        'incomplete', pas gÃ©nÃ©rÃ© partiellement en silence.
        ðŸ”´ BLOQUE CI si non respectÃ©.
        """
        result = generate_cba(case_with_missing_scores.id)

        assert result.status == 'incomplete', (
            "Â§9 violÃ© : CBA incomplet gÃ©nÃ©rÃ© sans marquage"
        )
        assert result.reason is not None, (
            "Â§9 : La raison de l'incomplÃ©tude doit Ãªtre fournie"
        )
        assert result.export_uri is None, (
            "Â§9 : Un CBA incomplet ne doit pas produire de fichier"
        )

    def test_pv_without_locked_committee_rejected(
        self, case_with_draft_committee
    ):
        """
        Un PV ne peut pas Ãªtre gÃ©nÃ©rÃ© sans comitÃ© verrouillÃ©.
        Â§9 : PV douteux = non gÃ©nÃ©rÃ©s.
        """
        result = generate_pv(case_with_draft_committee.id)

        assert result.status == 'blocked', (
            "Â§9 violÃ© : PV gÃ©nÃ©rÃ© sans comitÃ© verrouillÃ©"
        )
        assert 'committee' in result.reason.lower()

    def test_uncertain_normalisation_flagged_in_cba(
        self, case_with_low_confidence_items
    ):
        """
        Â§9 : Calculs incertains (confidence < 0.75) = signalÃ©s
        dans le CBA, pas masquÃ©s.
        """
        result = generate_cba(case_with_low_confidence_items.id)

        # Le CBA peut Ãªtre gÃ©nÃ©rÃ© mais doit signaler l'incertitude
        assert result.has_uncertainty_flags is True, (
            "Â§9 : Items Ã  faible confiance doivent Ãªtre flaggÃ©s"
        )
        assert len(result.uncertainty_details) > 0
```

---

## 3. Alternatives rejetÃ©es

| Alternative | Raison du rejet |
|-------------|----------------|
| Dictionnaire "on the fly" sans seed au dÃ©ploiement | Moat inexistant au lancement, adoption bloquÃ©e |
| SLA unique 60s OCR+natif | Promesse non tenue sur scans terrain = crÃ©dibilitÃ© perdue |
| FrontiÃ¨re A/B par convention de nommage uniquement | Contournable par import indirect ou alias |
| Gate CI exports en review manuelle | Â§9 non opposable, audit impossible |
| Market Signal avec rÃ¨gle de prÃ©dominance non documentÃ©e | AgrÃ©gation arbitraire, non dÃ©fendable en comitÃ© |

---

## 4. ConsÃ©quences

### 4.1 â€” Sur les milestones existants

| Milestone | Impact ADR-0002 |
|-----------|----------------|
| M-NORMALISATION-ITEMS | Scope Ã©tendu : seed obligatoire 9 familles + aliases SAHEL |
| M-MARKET-SIGNAL-ENGINE | RÃ¨gles MS-1/MS-2/MS-3/MS-DEGRADE opposables |
| M-MARKET-SURVEY-WORKFLOW | RÃ¨gles SR-1 Ã  SR-7 opposables |
| M-SCORING-ENGINE | Test analyse statique imports Couche B ajoutÃ© |
| M-PIPELINE-A-E2E | SLA deux classes (A/B) remplace SLA unique |
| M-COMMITTEE-CORE | Tests triggers DB-level ajoutÃ©s |
| M-EXTRACTION-CORRECTIONS | Tests triggers DB-level ajoutÃ©s |
| M-CBA-GEN / M-PV-GEN | Doctrine Â§9 testÃ©e en CI |

### 4.2 â€” Sur le registre des tests CI bloquants

```
REGISTRE COMPLET POST ADR-0002
(ðŸ”´ = BLOQUANT CI â€” aucune PR mergÃ©e si Ã©chec)

PHASE 0 â€” Fondations:
  ðŸ”´ test_corrections_append_only.py
  ðŸ”´ test_trigger_blocks_update.py          [DB-level]
  ðŸ”´ test_trigger_blocks_delete.py          [DB-level]
  ðŸ”´ test_upload_magic_bytes.py

PHASE 1 â€” Normalisation:
  ðŸ”´ test_no_raw_offer_in_scoring.py
  ðŸ”´ test_dict_minimum_coverage.py          [NOUVEAU ADR-0002]
  ðŸ”´ test_aliases_mandatory_sahel.py        [NOUVEAU ADR-0002]

PHASE 2 â€” Scoring + ComitÃ©:
  ðŸ”´ test_couche_a_b_boundary.py            [NOUVEAU ADR-0002 â€” AST]
  ðŸ”´ test_no_couche_b_import_in_couche_a.py [NOUVEAU ADR-0002 â€” AST]
  ðŸ”´ test_scores_independent_of_couche_b.py
  ðŸ”´ test_market_signal_no_impact_on_scores.py
  ðŸ”´ test_market_signal_read_only_couche_a.py [NOUVEAU ADR-0002]
  ðŸ”´ test_lock_prevents_member_insert.py    [DB-level]
  ðŸ”´ test_lock_prevents_member_update.py    [DB-level]
  ðŸ”´ test_lock_prevents_member_delete.py    [DB-level]
  ðŸ”´ test_lock_is_irreversible.py           [DB-level]

PHASE 3 â€” SLA + GÃ©nÃ©ration:
  ðŸ”´ test_sla_classe_a_60s.py               [PDF natifs/XLSX/DOCX]
  ðŸ”´ test_sla_classe_b_has_queue.py         [NOUVEAU ADR-0002]
  ðŸ”´ test_sla_classe_b_no_block.py          [NOUVEAU ADR-0002]
  ðŸ”´ test_incomplete_cba_marked.py          [NOUVEAU ADR-0002 â€” Â§9]
  ðŸ”´ test_pv_without_locked_committee.py    [NOUVEAU ADR-0002 â€” Â§9]

PHASE 5 â€” Market Signal:
  ðŸ”´ test_market_signal_rules_ms1_ms2_ms3.py [NOUVEAU ADR-0002]
  ðŸ”´ test_survey_minimum_3_cotations.py      [NOUVEAU ADR-0002]
  ðŸ”´ test_survey_zone_obligatoire.py         [NOUVEAU ADR-0002]
  ðŸ”´ test_survey_validity_90j.py             [NOUVEAU ADR-0002]

TOTAL : 24 gates CI bloquants
```

---

## 5. Notes d'implÃ©mentation anti-contournement

```
1. Emplacement ADR : docs/adrs/ADR-0002.md

2. Le dictionnaire seed est versionnÃ© dans :
   db/seeds/procurement_dict_v1.sql
   (jamais dans le code applicatif â€” sÃ©paration stricte)

3. Les rÃ¨gles Market Signal (MS-1 Ã  MS-DEGRADE) sont 
   implÃ©mentÃ©es comme donnÃ©es, pas comme code :
   table market_signal_rules (rule_id, condition, priority, description)
   â†’ modifiable sans dÃ©ploiement, auditÃ©e append-only

4. Les aliases SAHEL sont seedÃ©s via migration Alembic dÃ©diÃ©e :
   alembic/versions/XXX_seed_aliases_sahel.py
   (idempotent : INSERT IF NOT EXISTS)

5. Les tests AST (analyse statique) font partie de la suite
   tests/invariants/ et s'exÃ©cutent avant les tests unitaires
   dans le pipeline CI (fail-fast)

6. Seuil_alerte Market Survey (SR-7) est configurable par
   organisation via table org_settings, valeur par dÃ©faut : 1 000 000 XOF
```

---

## 6. DÃ©cision finale

Cet ADR est **ACCEPTÃ‰** et constitue le **complÃ©ment opÃ©rationnel** d'ADR-0001.

Il ne refonde pas : il **bÃ©tonise**.

Toute modification des rÃ¨gles dÃ©finies dans cet ADR (rÃ¨gles Market Signal MS-x, rÃ¨gles Survey SR-x, couverture dictionnaire, gates CI) doit passer par :
- un nouvel ADR (ADR-0003+),
- une validation CTO explicite.

---

```
STATUT FINAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ADR-0002 : ACCEPTED
ComplÃ¨te : ADR-0001
Freeze :   Ã€ inclure dans tag v3.3.2-freeze (patch)
Scope :    BÃ©tonisation niveau standard Sahel
           Non refonte â€” Non ajout de milestones

Tests CI bloquants ajoutÃ©s : 11 (total cumulÃ© : 24)
Familles dictionnaire : 9 (couverture minimale opposable)
RÃ¨gles Market Signal : 4 (MS-1 Ã  MS-DEGRADE)
RÃ¨gles Survey terrain : 7 (SR-1 Ã  SR-7)

Â© 2026 â€” Decision Memory System â€” ADR-0002
```

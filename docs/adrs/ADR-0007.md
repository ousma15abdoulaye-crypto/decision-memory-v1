# ADR-0007 — Freeze M-EXTRACTION-CORRECTIONS

**Identifiant**: ADR-0007  
**Statut**: FROZEN ✅  
**Date freeze**: 2026-02-20  
**Objet**: Milestone #4 M-EXTRACTION-CORRECTIONS — règles canoniques, zéro dérive  
**Précédents**: ADR-0001 · ADR-0002 · ADR-0003 · ADR-0004 · ADR-0005 · ADR-0006

---

## 0. Préambule

Ce document fige les décisions pour M-EXTRACTION-CORRECTIONS. Aucune déviation sans révision formelle de l’ADR.

---

## 1. Format révisions Alembic

| Règle | Valeur |
|-------|--------|
| Pattern | **0XX_** (ex: 015_m_extraction_corrections) |
| Interdit | Inventer un hash (ex: caf949...) pour cette migration |
| down_revision | **014_ensure_extraction_tables** (dernière révision réelle Lot A) |

---

## 2. Hash conflit (déterministe)

- Algorithme: **SHA256** (pas MD5, pas valeur aléatoire).
- Entrée: `json.dumps(data, sort_keys=True, ensure_ascii=False).encode("utf-8")`
- Usage: détection de conflit parallèle. Si `expected_content_hash` ≠ hash effectif courant → 409 Conflict.

---

## 3. Politique pgcrypto

- **Autorisé** : pgcrypto déjà utilisé dans 012 et CI.
- Alternative si blocage: uuid-ossp pour `gen_random_uuid()` (non requise dans ce milestone).

---

## 4. Politique trigger extractions immuable

- **DÉSACTIVÉ** (Action 2 — RISQUE CI #2) : A0.5 (grep) ne détecte pas ORM/SQLAlchemy.
- Ouvrir ticket Phase 4/#15 pour activation après preuve béton.

---

## 5. Politique fichier routes

- Endpoints: dans **`src/api/routes/extractions.py`** existant.
- Interdit: créer `routes/corrections.py` ou autre fichier routes tant que extractions.py < 400 lignes.
- Preuve Lot A: extractions.py = 255 lignes.

---

## 6. Schéma extraction_corrections (canonique)

```sql
CREATE TABLE extraction_corrections (
    id                   VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()::text,
    extraction_id         TEXT NOT NULL REFERENCES extractions(id) ON DELETE CASCADE,
    document_id           TEXT NOT NULL,
    structured_data       JSONB NOT NULL,
    confidence_override  REAL,
    correction_reason    TEXT,
    corrected_by         TEXT NOT NULL,
    corrected_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

- `structured_data` : nouvel état effectif (override remplaçant extraction.structured_data).
- Hash conflit : utilisé uniquement à la requête (body `expected_content_hash`). Non stocké en DB.

---

## 7. Vues obligatoires

| Vue | Rôle |
|-----|------|
| `structured_data_effective` | Dernière correction par document_id, ou extraction.structured_data si aucune |
| `extraction_corrections_history` | `SELECT * FROM extraction_corrections ORDER BY corrected_at` |

---

## 8. Trigger append-only extraction_corrections

- Fonction: `enforce_extraction_corrections_append_only()`
- Bloque: UPDATE, DELETE sur extraction_corrections
- Autorise: INSERT uniquement

---

## 9. Endpoints API (dans extractions.py)

| Méthode | Chemin | Rôle |
|---------|--------|------|
| POST | `/api/extractions/documents/{document_id}/corrections` | Créer correction. Body: structured_data, expected_content_hash (optionnel) |
| GET | `/api/extractions/documents/{document_id}/effective` | Retourne structured_data_effective + content_hash |
| GET | `/api/extractions/documents/{document_id}/corrections/history` | Historique des corrections |

---

## 10. Fixtures & tests

- Fixtures: priorité **tests/db_integrity/conftest.py**.
- Modifier **tests/conftest.py** uniquement si nécessaire absolue.
- Zéro `pytest.skip()` pour « DB vide » : fixtures auto-suffisantes.

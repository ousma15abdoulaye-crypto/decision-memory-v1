MISSION AGENT ‚Äî PR#85 feat/M-EXTRACTION-ENGINE
text
MISSION    : UNBLOCK-PR85-FINAL
Date       : 2026-02-20
√âmetteur   : Abdoulaye Ousmane (Founder & CTO)
Destinataire : Agent de d√©veloppement (nouvel agent)
Branche    : feat/M-EXTRACTION-ENGINE
PR         : #85 (Draft ‚Üí Ready to merge)
Statut CI  : üî¥ BLOQU√âE ‚Äî 29 failed, 12 errors, 1 freeze violation
1. CONTEXTE PROJET ‚Äî LIS CECI AVANT TOUT
Ce qu'est le DMS
Le Decision Memory System est un assistant intelligent de procurement. Il est constitu√© de deux couches :

Couche A : moteur d'analyse (extraction, scoring, CBA/PV) ‚Äî autonome, jamais d√©pendante de B

Couche B : m√©moire de march√©, non prescriptive ‚Äî ne touche jamais aux scores

Le syst√®me est online-only, PostgreSQL uniquement, append-only, ERP-agnostic. Ces r√®gles sont grav√©es dans la Constitution V3.3.2 sous forme de 9 invariants opposables.

Documents de r√©f√©rence (lire dans cet ordre)
text
1. docs/freeze/v3.3.2/CONSTITUTION_DMS_V3.3.2.md  ‚Üê Loi fondamentale
2. docs/freeze/v3.3.2/MILESTONES_EXECUTION_PLAN_V3.3.2.md ‚Üê Plan canonique
3. docs/adrs/ADR-0001.md  ‚Üê Fusion M10-UX + discipline agents
4. docs/adrs/ADR-0002.md  ‚Üê B√©tonisation standards Sahel
Tu ne peux pas prendre de d√©cision architecturale sans ces 4 documents.

Milestone en cours : M-EXTRACTION-ENGINE
Ce milestone impl√©mente le moteur d'extraction de documents (PDF natif, XLSX, DOCX, scans OCR). Il cr√©e :

La table extraction_jobs (FSM : pending ‚Üí processing ‚Üí done/failed)

La table extraction_errors (append-only, doctrine d'√©chec ¬ß9)

Le service d'extraction avec d√©tection de m√©thode (SLA-A / SLA-B)

Les endpoints API d'extraction

Les tests d'int√©gration E2E

2. DISCIPLINE ABSOLUE ‚Äî LIS CECI COMME UN CONTRAT
text
‚ùå INTERDIT ‚Äî violations imm√©diates entra√Ænant rejet de la PR :

  1. Modifier un fichier dans docs/freeze/v3.3.2/
     sauf SHA256SUMS.txt pour recalcul autoris√©
  2. Cr√©er ou renommer un milestone sans ADR + validation CTO
  3. Merger avec CI rouge, m√™me "temporairement"
  4. Introduire de la logique Couche B dans la Couche A
  5. Ajouter une d√©pendance ERP ou une DB secondaire
  6. Supprimer ou modifier une migration Alembic existante
  7. Commiter sans message normalis√© (voir ¬ß4)
  8. Improviser une solution architecturale non document√©e

‚úÖ OBLIGATOIRE :

  1. Lire Constitution + Plan + ADR-0001 + ADR-0002 avant toute action
  2. Travailler UNIQUEMENT sur feat/M-EXTRACTION-ENGINE
  3. Un commit atomique par fix
  4. CI verte compl√®te avant de passer Draft ‚Üí Ready
  5. Chaque test FAILED doit √™tre r√©solu, pas contourn√©
  6. Les SKIPPED avec motif "milestone non actif" sont accept√©s
  7. Aucun SKIPPED caus√© par une fixture cass√©e
3. √âTAT ACTUEL DE LA CI ‚Äî DIAGNOSTIC COMPLET
R√©sultat du dernier run
text
29 FAILED | 12 ERROR | 204 PASSED | 45 SKIPPED
+ 1 violation freeze (ADR-0004.md checksum FAILED)
+ 10 PytestUnknownMarkWarning
5 causes racines identifi√©es (ne pas re-analyser)
CR-1 ‚Äî Tables manquantes en DB de test (19 FAILED + 12 ERROR)
Sympt√¥me :

text
psycopg.errors.UndefinedTable: relation "extraction_jobs" does not exist
psycopg.errors.UndefinedTable: relation "extraction_errors" does not exist
psycopg.errors.UndefinedTable: relation "documents" does not exist
Cause : Les migrations Alembic ne sont pas appliqu√©es avant pytest dans le workflow CI.

Fix : Dans .github/workflows/ci-main.yml, ajouter juste avant le step Run tests :

text
- name: Apply Alembic migrations
  run: alembic upgrade head
  env:
    DATABASE_URL: <m√™me valeur que le step pytest>
Si une fixture apply_migrations existe dans conftest.py avec subprocess.run(["alembic", "upgrade", "head"]) ‚Üí la supprimer pour √©viter les conflits.

CR-2 ‚Äî create_user() retourne None (5 FAILED)
Sympt√¥me :

text
AttributeError: 'NoneType' object has no attribute 'fetchone'
Tests concern√©s : test_register_user, test_rbac (x4)

Cause : En psycopg3, cur.execute() retourne None. Il faut appeler cur.fetchone() directement.

Fix dans src/auth.py :

python
# AVANT (bug psycopg3) :
result = cur.execute("INSERT INTO users ... RETURNING id", params)
user_id = result.fetchone()[0]

# APR√àS (correct) :
cur.execute("INSERT INTO users ... RETURNING id", params)
row = cur.fetchone()
if row is None:
    raise RuntimeError("INSERT users n'a rien retourn√©")
user_id = row[0]
V√©rifier que ce pattern n'existe pas ailleurs dans src/auth.py.

CR-3 ‚Äî _get_raw_connection introuvable (2 FAILED)
Sympt√¥me :

text
AttributeError: module 'src.db' does not have the attribute '_get_raw_connection'
Tests : test_retry_db_connection_success_after_failures, test_retry_db_fails_after_max_attempts

Cause : src/db a √©t√© refactoris√© en package. _get_raw_connection n'est plus export√© depuis src/db/__init__.py.

Fix option A (pr√©f√©r√© ‚Äî ne pas modifier les tests) :

python
# src/db/__init__.py ‚Äî ajouter √† la fin :
from src.db.connection import _get_raw_connection  # noqa: F401
Fix option B (si la fonction a √©t√© renomm√©e) :

bash
# Trouver le nom exact
grep -n "^def " src/db/connection.py
Puis dans tests/test_resilience.py, remplacer l'import par le nom exact trouv√©.

CR-4 ‚Äî DATABASE_URL ne l√®ve pas RuntimeError (1 FAILED)
Sympt√¥me :

text
FAILED tests/invariants/test_inv_04_online_only.py::test_inv_04_database_url_required
Failed: DID NOT RAISE RuntimeError
Fix dans src/db/__init__.py (ou connection.py, l√† o√π DATABASE_URL est lu) :

python
DATABASE_URL = os.getenv("DATABASE_URL")
if not DATABASE_URL:
    raise RuntimeError(
        "DATABASE_URL non d√©finie ‚Äî d√©marrage refus√©. "
        "DMS est online-only (INV-4, Constitution V3.3.2). "
        "Aucun fallback SQLite autoris√©."
    )
‚ö†Ô∏è Ce code s'ex√©cute √† l'import. En CI, DATABASE_URL doit √™tre d√©finie avant le step pytest.

CR-5 ‚Äî Violation freeze ADR-0004.md üî¥ (CI freeze bloqu√©e)
Sympt√¥me :

text
docs/freeze/v3.3.2/adrs/ADR-0004.md: FAILED
sha256sum: WARNING: 1 computed checksum did NOT match
Cause : Un commit de l'agent pr√©c√©dent a modifi√© docs/freeze/v3.3.2/adrs/ADR-0004.md sans recalculer SHA256SUMS.txt.

Diagnostic d'abord :

bash
# Voir si ADR-0004 existait dans le tag de freeze
git show v3.3.2-freeze:docs/freeze/v3.3.2/adrs/ADR-0004.md 2>&1

# Comparer avec l'√©tat actuel
sha256sum docs/freeze/v3.3.2/adrs/ADR-0004.md
grep ADR-0004 docs/freeze/v3.3.2/SHA256SUMS.txt
Cas A ‚Äî ADR-0004 existait dans le freeze et a √©t√© modifi√© :

bash
# Restaurer l'√©tat exact du freeze
git show v3.3.2-freeze:docs/freeze/v3.3.2/adrs/ADR-0004.md \
  > docs/freeze/v3.3.2/adrs/ADR-0004.md
Cas B ‚Äî ADR-0004 n'existait pas dans le freeze (ajout√© apr√®s) :

bash
# Recalculer SHA256SUMS.txt pour inclure ADR-0004
cd docs/freeze/v3.3.2
sha256sum \
  CONSTITUTION_DMS_V3.3.2.md \
  MILESTONES_EXECUTION_PLAN_V3.3.2.md \
  INVARIANTS.md \
  adrs/ADR-0001.md \
  adrs/ADR-0004.md \
  > SHA256SUMS.txt
‚ö†Ô∏è Le Cas B n'est valide que si ADR-0004 a √©t√© valid√© par CTO. En cas de doute ‚Üí Cas A.

CR-6 ‚Äî Marks pytest non enregistr√©s (10 warnings)
Sympt√¥me :

text
PytestUnknownMarkWarning: Unknown pytest.mark.db_integrity
PytestUnknownMarkWarning: Unknown pytest.mark.smoke
Fix dans pyproject.toml :

text
[tool.pytest.ini_options]
# Ajouter dans la section existante :
markers = [
    "db_integrity: tests int√©grit√© DB (triggers, FSM, append-only)",
    "smoke: tests de fum√©e rapides (chargement, instantiation)",
    "slow: tests lents (SLA, pipeline E2E)",
    "integration: tests d'int√©gration n√©cessitant une DB r√©elle",
]
4. ORDRE D'EX√âCUTION DES FIXES
text
1. CR-5  ‚Üí R√©parer freeze integrity (bloque tout merge)
2. CR-1  ‚Üí Migrations dans ci-main.yml (r√©sout 31 tests)
3. CR-2  ‚Üí fetchone() dans auth.py (r√©sout 5 tests)
4. CR-3  ‚Üí Exposer _get_raw_connection (r√©sout 2 tests)
5. CR-4  ‚Üí RuntimeError si DATABASE_URL absent (r√©sout 1 test)
6. CR-6  ‚Üí Enregistrer marks pytest (r√©sout 10 warnings)
5. FORMAT DES COMMITS
text
fix(freeze): repair SHA256SUMS.txt for ADR-0004.md
fix(ci): add alembic upgrade head before pytest in ci-main.yml
fix(auth): use cursor.fetchone() instead of execute().fetchone()
fix(db): expose _get_raw_connection in src/db/__init__.py
fix(db): raise RuntimeError if DATABASE_URL is missing
fix(pytest): register custom marks db_integrity smoke slow integration
6. V√âRIFICATION FINALE AVANT DRAFT ‚Üí READY
bash
# √âtape 1 ‚Äî Freeze intact
sha256sum -c docs/freeze/v3.3.2/SHA256SUMS.txt
# Attendu : TOUS les fichiers ‚Üí OK, aucun FAILED

# √âtape 2 ‚Äî Migrations
alembic upgrade head
# Attendu : exit code 0, "Running upgrade ... -> head"

# √âtape 3 ‚Äî Format + lint
black --check src/ tests/ main.py
ruff check src/ tests/ main.py
# Attendu : 0 erreur

# √âtape 4 ‚Äî Tests complets
pytest tests/ -v --tb=short 2>&1 | tail -5
# Attendu : X passed, 0 failed, 0 error, Y skipped

# √âtape 5 ‚Äî Aucun warning
pytest tests/ -v 2>&1 | grep -i "warning" | grep -v "PytestUnknown"
# Attendu : 0 r√©sultat
7. DEFINITION OF DONE PR#85
text
‚úÖ ci-freeze-integrity   ‚Üí SHA256SUMS.txt : TOUS OK
‚úÖ ci-main               ‚Üí 0 FAILED, 0 ERROR
‚úÖ ci-invariants         ‚Üí tous les invariants INV-01 √† INV-09 passent
‚úÖ ci-lint-ruff          ‚Üí 0 erreur
‚úÖ ci-format-black       ‚Üí formatted
‚úÖ ci-milestones-gates   ‚Üí s√©quence milestones respect√©e
‚úÖ SKIPPED               ‚Üí uniquement tests avec skip milestone explicite
‚úÖ PytestUnknownMarkWarning ‚Üí 0
‚úÖ Draft ‚Üí Ready          ‚Üí seulement quand toutes les gates sont vertes
‚úÖ .milestones/M-EXTRACTION-ENGINE.done ‚Üí cr√©√© dans ce commit final
8. SI TU BLOQUES
text
R√®gle stricte :
  Si un fix n√©cessite une d√©cision architecturale
  ‚Üí STOP imm√©diat
  ‚Üí Poster un commentaire sur PR#85 avec :
      - Le blocage exact (fichier, ligne, erreur)
      - Ce que tu as essay√©
      - Ce que tu ne sais pas d√©cider seul
  ‚Üí NE PAS improviser
  ‚Üí NE PAS cr√©er de nouveaux milestones ou ADR
  ‚Üí Attendre validation CTO

Seuls fichiers autoris√©s dans ce mandat :
  .github/workflows/ci-main.yml
  conftest.py (racine) ‚Äî suppression fixture apply_migrations si pr√©sente
  src/auth.py
  src/db/__init__.py
  src/db/connection.py
  pyproject.toml
  docs/freeze/v3.3.2/SHA256SUMS.txt (recalcul uniquement)
  tests/test_resilience.py (option B CR-3 uniquement)

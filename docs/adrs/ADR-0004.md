ADR-0004 — Correction Phase 0 & M-SCHEMA-CORE
Status       : ACCEPTED — À GELER
Date         : 2026-02-19
Author       : Abdoulaye Ousmane (Founder & CTO)
Constitution : V3.3.2 (canonique, frozen)
Précédent    : ADR-0003 (Plan d'exécution CTO Grade V3.3.2)

1. Objet
Ce document :

- Introduit explicitement le milestone **M-SCHEMA-CORE** dans la Phase 0.
- Corrige la séquence interne de la Phase 0.
- Fige le **prompt système agent** mis à jour.
- Documente une **exception de nommage** pour la migration Alembic `011_add_missing_schema.py`.

Il complète ADR-0003 sans le contredire.

2. Phase 0 corrigée (opposable)

Référence ADR-0003 §2.3 — Phase 0 (milestones fondations).

Séquence Phase 0 corrigée :

1. **M-SCHEMA-CORE** — Schéma DB constitutionnel minimal
2. **M-DOCS-CORE** — Architecture, glossaire, contributing
3. **M-EXTRACTION-ENGINE**
4. **M-EXTRACTION-CORRECTIONS**

État au 2026-02-19 :

- M-SCHEMA-CORE : ✅ DONE (PR #84 mergée 2026-02-19)
- M-DOCS-CORE   : ⏳ PROCHAIN MILESTONE
- M-EXTRACTION-ENGINE : ❌ À FAIRE
- M-EXTRACTION-CORRECTIONS : ❌ À FAIRE

Règles inchangées :

- Interdiction absolue de démarrer M-EXTRACTION-ENGINE tant que :
  - M-SCHEMA-CORE n'est pas DONE
  - M-DOCS-CORE n'est pas DONE

3. Prompt système agent (gelé)

Le prompt suivant remplace et étend la section 10 d'ADR-0003.
Il est **opposable** à tout agent (humain ou IA).

```text
DMS V3.3.2 — À INCLURE DANS TOUTE SESSION
════════════════════════════════════════════════════════════

Tu interviens sur le Decision Memory System (DMS) V3.3.2.

DOCUMENTS DE RÉFÉRENCE OBLIGATOIRES (lire avant tout code) :
  docs/CONSTITUTION_DMS_V3.3.2.md
  docs/MILESTONES_EXECUTION_PLAN_V3.3.2.md
  docs/adrs/ADR-0001.md
  docs/adrs/ADR-0002.md
  docs/adrs/ADR-0003.md
  docs/adrs/ADR-0004.md

MILESTONE ACTIF     : [À RENSEIGNER PAR LE CTO]
ÉTAPE COURANTE      : [À RENSEIGNER — voir ADR-0003 §2.2]
DERNIÈRE CI         : [verte / rouge]

SÉQUENCE PHASE 0 CORRIGÉE (ADR-0004 §2) :
  ✅ M-SCHEMA-CORE     → DONE (mergé 2026-02-19)
  ⏳ M-DOCS-CORE       → PROCHAIN MILESTONE
  ⏳ M-EXTRACTION-ENGINE
  ⏳ M-EXTRACTION-CORRECTIONS

RÈGLES NON NÉGOCIABLES (ADR-0003 + ADR-0004) :
  1. Séquence interne §2.2 ADR-0003 stricte.
  2. Jamais d'ORM. Requêtes paramétrées exclusivement.
  3. Jamais d'import Couche B dans Couche A.
  4. Triggers PostgreSQL dans migrations SQL, pas Python.
  5. CI rouge = stop immédiat. Aucune PR mergée.
  6. Milestone .done uniquement après make test vert.
  7. Milestone non listé dans ADR → signaler CTO → STOP.
  8. Nommage migration → vérifier ADR-0003 §3.2 avant.

Tu ne proposes pas d'alternative au plan.
Tu ne simplifies pas les règles.
Tu exécutes l'étape courante du milestone actif.
════════════════════════════════════════════════════════════
```

4. Exception de nommage — migration 011 (opposable)

4.1. Constat

- Fichier : `alembic/versions/011_add_missing_schema.py`
- Revision ID : `011_add_missing_schema`
- Down revision : `010_enforce_append_only_audit`
- Milestone : M-SCHEMA-CORE (docstring ligne 7)
- Statut : ✅ migration mergée sur `main` (commit `0ebfb6c`, PR #84)

Cette migration implémente :

- Table `dictionary` (dictionnaire Sahel, 9 familles).
- Table `market_data` (mémoire marché append-only Couche B).

Elle est conforme à la Constitution V3.3.2, mais **son nom n'est pas conforme**
à la convention ADR-0003 §3.2 :

- Format attendu : `NNN_<id_milestone_snake>.py`
- Nom actuel : `011_add_missing_schema.py`

4.2. Décision

Par application du principe de stabilité des migrations, **il est interdit**
de modifier une migration déjà mergée sur `main` et potentiellement appliquée
en environnement partagé (staging / production).

En conséquence :

- La migration `011_add_missing_schema.py` **n'est pas renommée**.
- Son `revision` reste : `011_add_missing_schema`.

Cette migration est **acceptée par exception documentée**.

4.3. Règle opposable

1. Toutes les migrations **postérieures** à ADR-0004 doivent respecter
   strictement la convention ADR-0003 §3.2 :

   - Format : `NNN_m_<id_milestone_snake>.py`
   - Exemple : `012_m_docs_core.py`, `013_m_extraction_engine.py`.

2. Les migrations **antérieures** à ADR-0004 et déjà mergées sur `main`
   (dont `011_add_missing_schema.py`) peuvent conserver leur nom original.

3. Il est **interdit** de modifier `revision` ou `down_revision` d'une
   migration déjà mergée sur `main`, sauf ADR dédié et plan de migration
   explicite (rollback contrôlé, script de transition, etc.).

5. Ordres de modification (à exécuter)

Les modifications suivantes doivent être effectuées dans le repo
pour rendre ADR-0004 effectif.

5.1. Références documentaires

- Ajouter `docs/adrs/ADR-0004.md` à la liste des documents de référence
  obligatoires dans :
  - `docs/CONTRIBUTING.md`
  - Tout RUNBOOK ou guide de travail qui liste ADR-0003.

5.2. État des lieux milestones

- Mettre à jour tout rapport d'état des lieux (ex. `docs/ETAT_DES_LIEUX_*.md`)
  pour refléter :
  - Phase 0 corrigée (M-SCHEMA-CORE en premier, DONE).
  - M-DOCS-CORE comme prochain milestone.

5.3. Prompt système dans outils

- Mettre à jour les prompts système utilisés par les agents IA
  (Cursor, Copilot, etc.) pour refléter la section 3 ci-dessus.

6. Conséquences

- M-SCHEMA-CORE devient le point d'entrée officiel de la Phase 0.
- La dette de nommage de la migration 011 est **circonscrite** et
  **documentée**.
- Toute migration future non conforme à ADR-0003 §3.2 sera considérée
  comme une erreur de procédure.

FREEZE : Ce document est prêt pour copie dans `docs/freeze/v3.3.2/adrs/ADR-0004.md`
après validation CTO et mise à jour du FREEZE_MANIFEST.

